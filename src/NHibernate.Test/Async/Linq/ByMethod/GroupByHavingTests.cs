//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System;
using System.Linq;
using NHibernate.DomainModel.Northwind.Entities;
using NUnit.Framework;
using NHibernate.Linq;

namespace NHibernate.Test.Linq.ByMethod
{
	using System.Threading.Tasks;
	[TestFixture]
	public class GroupByHavingTestsAsync : LinqTestCase
	{
		protected override void Configure(Cfg.Configuration configuration)
		{
			base.Configure(configuration);
			configuration.SetProperty(Cfg.Environment.ShowSql, "true");
		} 

		[Test]
		public async Task HavingCountSelectCountAsync()
		{
			var list = await ((from o in db.Orders
						group o by o.OrderDate
						into g
						where g.Count() > 4
						select g.Count()).ToListAsync());

			Assert.That(list.Count, Is.EqualTo(1));
			Assert.That(list.Single(), Is.EqualTo(5));
		}

		[Test]
		public async Task HavingCountSelectCountWithInnerWhereAsync()
		{
			var list = await ((from o in db.Orders
						where o.RequiredDate < DateTime.Now
						group o by o.OrderDate
						into g
						where g.Count() > 4
						select g.Count()).ToListAsync());

			Assert.That(list.Count, Is.EqualTo(1));
			Assert.That(list.Single(), Is.EqualTo(5));
		}

		[Test]
		public async Task HavingCountSelectKeyAsync()
		{
			var list = await ((from o in db.Orders
						group o by o.OrderDate
						into g
						where g.Count() > 4
						select g.Key).ToListAsync());

			Assert.That(list.Count, Is.EqualTo(1));
		}

		[Test]
		public async Task HavingCountSelectKeyWithInnerWhereAsync()
		{
			var list = await ((from o in db.Orders
						where o.RequiredDate < DateTime.Now
						group o by o.OrderDate
						into g
						where g.Count() > 4
						select g.Key).ToListAsync());

			Assert.That(list.Count, Is.EqualTo(1));
		}

		[Test]
		public async Task HavingCountSelectTupleKeyCountAsync()
		{
			var list = await ((from o in db.Orders
						group o by o.OrderDate
						into g
						where g.Count() > 4
						select new {g.Key, Count = g.Count()}).ToListAsync());

			Assert.That(list.Count, Is.EqualTo(1));
			Assert.That(list.Single().Count, Is.EqualTo(5));
		}

		[Test]
		public async Task HavingCountSelectTupleKeyCountOfOrdersAsync()
		{
			var list = await ((from o in db.Orders
						group o by o.OrderDate
						into g
						where g.Count() > 4
						select new {g.Key, Count = g.Select(x => x.OrderId).Count()}).ToListAsync());

			Assert.That(list.Count, Is.EqualTo(1));
			Assert.That(list.Single().Count, Is.EqualTo(5));
		}

		[Test, KnownBug("NH-????"), Description("I suspect that this case isn't executed correctly - the sql doesn't mention the orderlines. /Oskar 2012-01-22")]
		public async Task HavingCountSelectTupleKeyCountOfOrderLinesAsync()
		{
			var list = await ((from o in db.Orders
						group o by o.OrderDate
						into g
						where g.Count() > 4
						select new
								   {
									   g.Key,
									   Count = g.SelectMany(x => x.OrderLines).Count()
								   }).ToListAsync());

			Assert.That(list.Count, Is.EqualTo(1));
			Assert.That(list.Single().Count, Is.EqualTo(14));
		}

		[Test]
		public async Task ComplexQueryAsync()
		{
			var list = await ((from o in db.Orders
						where o.RequiredDate < DateTime.Now
						group o by o.OrderDate
						into g
						where g.Count() > 4 && g.Key < DateTime.Now
						select g.Count()).ToListAsync());

			Assert.AreEqual(1, list.Count);
		}

		[Test]
		public async Task SingleKeyGroupAndCountWithHavingClauseAsync()
		{
			//NH-2833
			var orderCounts = await (db.Orders
				.GroupBy(o => o.Customer.CompanyName)
				.Where(g => g.Count() > 10)
				.Select(g => new { CompanyName = g.Key, OrderCount = g.Count() })
				.ToListAsync());

			Assert.That(orderCounts, Has.Count.EqualTo(28));
			var hornRow = orderCounts.Single(row => row.CompanyName == "Around the Horn");
			Assert.That(hornRow.OrderCount, Is.EqualTo(13));
		}

		[Test]
		public async Task HavingWithStringEnumParameterAsync()
		{
			await (db.Users
			  .GroupBy(p => p.Enum1)
			  .Where(g => g.Key == EnumStoredAsString.Large)
			  .Select(g => g.Count())
			  .ToListAsync());
			await (db.Users
			  .GroupBy(p => new StringEnumGroup {Enum = p.Enum1})
			  .Where(g => g.Key.Enum == EnumStoredAsString.Large)
			  .Select(g => g.Count())
			  .ToListAsync());
			await (db.Users
			  .GroupBy(p => new[] {p.Enum1})
			  .Where(g => g.Key[0] == EnumStoredAsString.Large)
			  .Select(g => g.Count())
			  .ToListAsync());
			await (db.Users
			  .GroupBy(p => new {p.Enum1})
			  .Where(g => g.Key.Enum1 == EnumStoredAsString.Large)
			  .Select(g => g.Count())
			  .ToListAsync());
			await (db.Users
			  .GroupBy(p => new {Test = new {Test2 = p.Enum1}})
			  .Where(g => g.Key.Test.Test2 == EnumStoredAsString.Large)
			  .Select(g => g.Count())
			  .ToListAsync());
			await (db.Users
			  .GroupBy(p => new {Test = new[] {p.Enum1}})
			  .Where(g => g.Key.Test[0] == EnumStoredAsString.Large)
			  .Select(g => g.Count())
			  .ToListAsync());
		}

		private class StringEnumGroup
		{
			public EnumStoredAsString Enum { get; set; }
		}
	}
}
