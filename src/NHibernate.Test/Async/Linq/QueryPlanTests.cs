//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System.Linq;
using NHibernate.Dialect;
using NHibernate.Linq;
using NSubstitute;
using NSubstitute.Extensions;
using NUnit.Framework;

namespace NHibernate.Test.Linq
{
	using System.Threading.Tasks;
	[TestFixture]
	public class QueryPlanTestsAsync : LinqTestCase
	{
		[Test]
		public async Task SelectConstantShouldBeCachedAsync()
		{
			ClearQueryPlanCache();

			var c1 = await (db.Customers.Select(o => new {o.CustomerId, Constant = "constant"}).FirstAsync());
			var c2 = await (db.Customers.Select(o => new {o.CustomerId, Constant = "constant2"}).FirstAsync());
			var constant = "constant3";
			var c3 = await (db.Customers.Select(o => new {o.CustomerId, Constant = constant}).FirstAsync());
			constant = "constant4";
			var c4 = await (db.Customers.Select(o => new {o.CustomerId, Constant = constant}).FirstAsync());

			var queryCache = GetQueryPlanCache();
			Assert.That(queryCache.Count, Is.EqualTo(1));

			Assert.That(c1.Constant, Is.EqualTo("constant"));
			Assert.That(c2.Constant, Is.EqualTo("constant2"));
			Assert.That(c3.Constant, Is.EqualTo("constant3"));
			Assert.That(c4.Constant, Is.EqualTo("constant4"));
		}

		[Test]
		public async Task GroupByConstantShouldBeCachedAsync()
		{
			ClearQueryPlanCache();

			var c1 = await (db.Customers.GroupBy(o => new {o.CustomerId, Constant = "constant"}).Select(o => o.Key).FirstAsync());
			var c2 = await (db.Customers.GroupBy(o => new {o.CustomerId, Constant = "constant2"}).Select(o => o.Key).FirstAsync());
			var constant = "constant3";
			var c3 = await (db.Customers.GroupBy(o => new {o.CustomerId, Constant = constant}).Select(o => o.Key).FirstAsync());
			constant = "constant4";
			var c4 = await (db.Customers.GroupBy(o => new {o.CustomerId, Constant = constant}).Select(o => o.Key).FirstAsync());

			var queryCache = GetQueryPlanCache();
			Assert.That(queryCache.Count, Is.EqualTo(1));

			Assert.That(c1.Constant, Is.EqualTo("constant"));
			Assert.That(c2.Constant, Is.EqualTo("constant2"));
			Assert.That(c3.Constant, Is.EqualTo("constant3"));
			Assert.That(c4.Constant, Is.EqualTo("constant4"));
		}

		[Test]
		public async Task WithLockShouldBeCachedAsync()
		{
			ClearQueryPlanCache();
			// Limit to a few dialects where we know the "nowait" keyword is used to make life easier.
			Assume.That(Dialect is MsSql2000Dialect || Dialect is Oracle8iDialect || Dialect is PostgreSQL81Dialect);

			await (db.Customers.WithLock(LockMode.Upgrade).ToListAsync());
			await (db.Customers.WithLock(LockMode.UpgradeNoWait).ToListAsync());
			var lockMode = LockMode.None;
			await (db.Customers.WithLock(lockMode).ToListAsync());
			lockMode = LockMode.Read;
			await (db.Customers.WithLock(lockMode).ToListAsync());

			var queryCache = GetQueryPlanCache();
			Assert.That(queryCache.Count, Is.EqualTo(4));
		}

		[TestCase(true)]
		[TestCase(false)]
		public async Task SkipShouldBeCachedAsync(bool supportsVariableLimit)
		{
			if (!Dialect.SupportsLimit || (supportsVariableLimit && !Dialect.SupportsVariableLimit))
			{
				Assert.Ignore();
			}

			ClearQueryPlanCache();
			using (var substitute = SubstituteDialect())
			{
				substitute.Value.Configure().SupportsVariableLimit.Returns(supportsVariableLimit);

				var c1 = await (db.Customers.Skip(1).ToListAsync());
				var c2 = await (db.Customers.Skip(2).ToListAsync());
				var skip = 3;
				var c3 = await (db.Customers.Skip(skip).ToListAsync());
				skip = 4;
				var c4 = await (db.Customers.Skip(skip).ToListAsync());

				var queryCache = GetQueryPlanCache();
				Assert.That(c1.Count, Is.Not.EqualTo(c2.Count));
				Assert.That(c2.Count, Is.Not.EqualTo(c3.Count));
				Assert.That(c3.Count, Is.Not.EqualTo(c4.Count));
				Assert.That(queryCache.Count, Is.EqualTo(supportsVariableLimit ? 1 : 4));
			}
		}

		[TestCase(true)]
		[TestCase(false)]
		public async Task TakeShouldBeCachedAsync(bool supportsVariableLimit)
		{
			if (!Dialect.SupportsLimit || (supportsVariableLimit && !Dialect.SupportsVariableLimit))
			{
				Assert.Ignore();
			}

			ClearQueryPlanCache();
			using (var substitute = SubstituteDialect())
			{
				substitute.Value.Configure().SupportsVariableLimit.Returns(supportsVariableLimit);

				var c1 = await (db.Customers.Take(1).ToListAsync());
				var c2 = await (db.Customers.Take(2).ToListAsync());
				var skip = 3;
				var c3 = await (db.Customers.Take(skip).ToListAsync());
				skip = 4;
				var c4 = await (db.Customers.Take(skip).ToListAsync());

				var queryCache = GetQueryPlanCache();
				Assert.That(c1.Count, Is.EqualTo(1));
				Assert.That(c2.Count, Is.EqualTo(2));
				Assert.That(c3.Count, Is.EqualTo(3));
				Assert.That(c4.Count, Is.EqualTo(4));
				Assert.That(queryCache.Count, Is.EqualTo(supportsVariableLimit ? 1 : 4));
			}
		}

		[Test]
		public async Task TrimFunctionShouldNotBeCachedAsync()
		{
			ClearQueryPlanCache();

			await (db.Customers.Select(o => new {CustomerId = o.CustomerId.Trim('-')}).FirstAsync());
			await (db.Customers.Select(o => new {CustomerId = o.CustomerId.Trim('+')}).FirstAsync());

			var queryCache = GetQueryPlanCache();
			Assert.That(queryCache.Count, Is.EqualTo(0));
		}

		[Test]
		public async Task SubstringFunctionShouldBeCachedAsync()
		{
			ClearQueryPlanCache();

			var queryCache = GetQueryPlanCache();
			var c1 = await (db.Customers.Select(o => new {Name = o.ContactName.Substring(1)}).FirstAsync());
			var c2 = await (db.Customers.Select(o => new {Name = o.ContactName.Substring(2)}).FirstAsync());

			Assert.That(c1.Name, Is.Not.EqualTo(c2.Name));
			Assert.That(queryCache.Count, Is.EqualTo(1));

			ClearQueryPlanCache();
			c1 = await (db.Customers.Select(o => new { Name = o.ContactName.Substring(1, 2) }).FirstAsync());
			c2 = await (db.Customers.Select(o => new { Name = o.ContactName.Substring(2, 1) }).FirstAsync());

			Assert.That(c1.Name, Is.Not.EqualTo(c2.Name));
			Assert.That(queryCache.Count, Is.EqualTo(1));
		}
	}
}
