//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System;
using System.Collections;
using System.Linq;
using NHibernate.Multi;
using NHibernate.Transform;
using NUnit.Framework;

namespace NHibernate.Test.NHSpecificTest.NH1836
{
	using System.Threading.Tasks;
	using System.Threading;
	[TestFixture]
	public class FixtureAsync : BugTestCase
	{
		protected override bool AppliesTo(Engine.ISessionFactoryImplementor factory)
		{
			return factory.ConnectionProvider.Driver.SupportsMultipleQueries;
		}

		protected override void OnSetUp()
		{
			base.OnSetUp();

			using (var s = OpenSession())
			using (var t = s.BeginTransaction())
			{
				s.Save(new Entity {Id = 1});
				t.Commit();
			}
		}

		[Test, Obsolete]
		public void AliasToBeanTransformerShouldApplyCorrectlyToMultiQueryAsync()
		{
			using (var s = OpenSession())
			using (var t = s.BeginTransaction())
			{
				IMultiQuery multiQuery = s.CreateMultiQuery()
					.Add(s.CreateQuery("select entity.Id as EntityId from Entity entity")
						.SetResultTransformer(Transformers.AliasToBean(typeof(EntityDTO)))
					);

				IList results = null;
				Assert.That(async () => results = await (multiQuery.ListAsync()), Throws.Nothing);
				var elementOfFirstResult = ((IList)results[0])[0];
				Assert.That(elementOfFirstResult, Is.TypeOf<EntityDTO>().And.Property("EntityId").EqualTo(1));
			}
		}

		[Test]
		public async Task AliasToBeanTransformerShouldApplyCorrectlyToQueryBatchAsync()
		{
			using (var s = OpenSession())
			using (var t = s.BeginTransaction())
			{
				var multiQuery = s
				                 .CreateQueryBatch()
				                 .Add<EntityDTO>(s
				                                 .CreateQuery("select entity.Id as EntityId from Entity entity")
				                                 .SetResultTransformer(Transformers.AliasToBean(typeof(EntityDTO))));

				Assert.That(multiQuery.Execute, Throws.Nothing);
				var results = await (multiQuery.GetResultAsync<EntityDTO>(0, CancellationToken.None));
				Assert.That(results.First(), Is.TypeOf<EntityDTO>().And.Property("EntityId").EqualTo(1));
				await (t.CommitAsync());
			}
		}

		protected override void OnTearDown()
		{
			base.OnTearDown();

			using (var s = OpenSession())
			using (var t = s.BeginTransaction())
			{
				s.CreateQuery("delete from System.Object").ExecuteUpdate();
				t.Commit();
			}
		}
	}
}
