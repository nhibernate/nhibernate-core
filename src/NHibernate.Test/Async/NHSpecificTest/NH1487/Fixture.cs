//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System;
using System.Text;
using NHibernate.Cfg;
using NHibernate.Dialect;
using NHibernate.Tool.hbm2ddl;
using NUnit.Framework;

namespace NHibernate.Test.NHSpecificTest.NH1487
{
	using System.Threading.Tasks;

	/// <summary>
	/// Summary description for TestTestCase.
	/// </summary>
	[TestFixture]
	public class FixtureAsync
	{

		public Configuration GetConf()
		{
			var cfg = new Configuration();
			if (TestConfigurationHelper.hibernateConfigFile != null)
				cfg.Configure(TestConfigurationHelper.hibernateConfigFile);
			return cfg;
		}

		[Test]
		public async Task GenerateSchemaMultipleUniqueKeysAsync()
		{
			var cfg = GetConf();
			if(!(Dialect.Dialect.GetDialect(cfg.Properties) is MsSql2000Dialect))
			{
				Assert.Ignore("Specific for MsSql2000Dialect");
			}
			const string hbm = @"<?xml version='1.0' encoding='utf-8' ?>
<hibernate-mapping xmlns='urn:nhibernate-mapping-2.2'
namespace='NHibernate.Test.NHSpecificTest.NH1487'
assembly='NHibernate.Test'>
    <class name='Entity' >
        <id name='Id' >
            <generator class='assigned' />
        </id>
        <property name='A' unique-key='AC'/>
        <property name='B' unique-key='BC'/>
        <property name='C' unique-key='AC, BC'/>
    </class>
</hibernate-mapping>";

			cfg.AddXmlString(hbm);

			// Can create the schema
			var scriptB = new StringBuilder();
			await (new SchemaExport(cfg).CreateAsync(sl => scriptB.Append(sl), true));
			var script = scriptB.ToString();
			Assert.That(script, Does.Contain("unique (A, C)"));
			Assert.That(script, Does.Contain("unique (B, C)"));
			Assert.That(script, Does.Not.Contain("unique (C)"));

			await (new SchemaExport(cfg).DropAsync(false, true));
		}

		[Test]
		public async Task GenerateSchemaMultipleIndexAsync()
		{
			var cfg = GetConf();
			if (!(Dialect.Dialect.GetDialect(cfg.Properties) is MsSql2000Dialect))
			{
				Assert.Ignore("Specific for MsSql2000Dialect");
			}
			const string hbm = @"<?xml version='1.0' encoding='utf-8' ?>
<hibernate-mapping xmlns='urn:nhibernate-mapping-2.2'
namespace='NHibernate.Test.NHSpecificTest.NH1487'
assembly='NHibernate.Test'>
    <class name='Entity' >
        <id name='Id' >
            <generator class='assigned' />
        </id>
        <property name='A' index='AC'/>
        <property name='B' index='BC'/>
        <property name='C' index='AC, BC'/>
    </class>
</hibernate-mapping>";

			cfg.AddXmlString(hbm);

			var scriptB = new StringBuilder();
			await (new SchemaExport(cfg).CreateAsync(sl => scriptB.Append(sl), true));
			var script = scriptB.ToString();
			Assert.That(script, Does.Contain("create index AC on Entity (A, C)"));
			Assert.That(script, Does.Contain("create index BC on Entity (B, C)"));

			await (new SchemaExport(cfg).DropAsync(false, true));
		}

		[Test]
		public async Task GenerateSchemaMultipleIndexOnColumnAsync()
		{
			var cfg = GetConf();
			if (!(Dialect.Dialect.GetDialect(cfg.Properties) is MsSql2000Dialect))
			{
				Assert.Ignore("Specific for MsSql2000Dialect");
			}
			const string hbm = @"<?xml version='1.0' encoding='utf-8' ?>
<hibernate-mapping xmlns='urn:nhibernate-mapping-2.2'
namespace='NHibernate.Test.NHSpecificTest.NH1487'
assembly='NHibernate.Test'>
    <class name='Entity' >
        <id name='Id' >
            <generator class='assigned' />
        </id>
        <property name='A'>
           <column name='A' index='AC'/>
        </property>
        <property name='B'>
           <column name='B' index='BC'/>
        </property>
        <property name='C'>
           <column name='C' index='AC,BC'/>
        </property>
    </class>
</hibernate-mapping>";

			cfg.AddXmlString(hbm);

			var scriptB = new StringBuilder();
			await (new SchemaExport(cfg).CreateAsync(sl => scriptB.Append(sl), true));
			var script = scriptB.ToString();
			Assert.That(script, Does.Contain("create index AC on Entity (A, C)"));
			Assert.That(script, Does.Contain("create index BC on Entity (B, C)"));

			await (new SchemaExport(cfg).DropAsync(false, true));
		}
		[Test]
		public async Task GenerateSchemaIndexOnIdAsync()
		{
			var cfg = GetConf();
			if (!(Dialect.Dialect.GetDialect(cfg.Properties) is MsSql2000Dialect))
			{
				Assert.Ignore("Specific for MsSql2000Dialect");
			}
			const string hbm = @"<?xml version='1.0' encoding='utf-8' ?>
<hibernate-mapping xmlns='urn:nhibernate-mapping-2.2'
namespace='NHibernate.Test.NHSpecificTest.NH1487'
assembly='NHibernate.Test'>
    <class name='Entity' >
        <id name='Id' >
            <column name='Id' index='IdxId1,IdxId2'/>
            <generator class='assigned' />
        </id>
        <property name='A'/>
        <property name='B'/>
        <property name='C'/>
    </class>
</hibernate-mapping>";

			cfg.AddXmlString(hbm);

			var scriptB = new StringBuilder();
			await (new SchemaExport(cfg).CreateAsync(sl => scriptB.Append(sl), true));
			var script = scriptB.ToString();
			Assert.That(script, Does.Contain("create index IdxId1 on Entity (Id)"));
			Assert.That(script, Does.Contain("create index IdxId2 on Entity (Id)"));

			await (new SchemaExport(cfg).DropAsync(false, true));
		}

		[Test]
		public async Task GenerateSchemaUniqueOnIdAsync()
		{
			var cfg = GetConf();
			if (!(Dialect.Dialect.GetDialect(cfg.Properties) is MsSql2000Dialect))
			{
				Assert.Ignore("Specific for MsSql2000Dialect");
			}
			const string hbm = @"<?xml version='1.0' encoding='utf-8' ?>
<hibernate-mapping xmlns='urn:nhibernate-mapping-2.2'
namespace='NHibernate.Test.NHSpecificTest.NH1487'
assembly='NHibernate.Test'>
    <class name='Entity' >
        <id name='Id' >
            <column name='Id' unique-key='UIdxId1,UIdxId2'/>
            <generator class='assigned' />
        </id>
        <property name='A'/>
        <property name='B'/>
        <property name='C'/>
    </class>
</hibernate-mapping>";

			cfg.AddXmlString(hbm);

			var scriptB = new StringBuilder();
			await (new SchemaExport(cfg).CreateAsync(sl => scriptB.AppendLine(sl), true));
			var script = scriptB.ToString().Split(new[] { System.Environment.NewLine, "\n" }, StringSplitOptions.RemoveEmptyEntries);
			int count=0;
			foreach (var s in script)
			{
				if (s.Contains("unique (Id)"))
					count++;
			}
			Assert.That(count, Is.EqualTo(2));

			await (new SchemaExport(cfg).DropAsync(false, true));
		}

	}
}
