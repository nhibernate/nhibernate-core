//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System.Collections;
using System.Data;
using System.Linq;
using NHibernate.Driver;
using NHibernate.Linq;
using NHibernate.SqlTypes;
using NUnit.Framework;

namespace NHibernate.Test.NHSpecificTest.NH3850
{
	using System.Threading.Tasks;
	using System.Threading;
	[TestFixture]
	public class DateTimeOffsetFixtureAsync : FixtureBaseAsync
	{
		protected override string[] Mappings => new[] { "DateTimeOffsetMappings.hbm.xml" };

		protected override bool AppliesTo(Dialect.Dialect dialect)
		{
			return TestDialect.SupportsSqlType(new SqlType(DbType.DateTimeOffset));
		}

		protected override bool AppliesTo(Engine.ISessionFactoryImplementor factory)
		{
			// Cannot handle DbType.DateTimeOffset via ODBC.
			return !(factory.ConnectionProvider.Driver is OdbcDriver);
		}

		protected override async Task MaxAsync<DC>(int? expectedResult, CancellationToken cancellationToken = default(CancellationToken))
		{
			using (var session = OpenSession())
			{
				var dcQuery = session.Query<DC>();
				var dateWithOffset = await (dcQuery.MaxAsync(dc => dc.DateTimeOffset, cancellationToken));
				var futureDateWithOffset = dcQuery.ToFutureValue(qdc => qdc.Max(dc => dc.DateTimeOffset));
				if (expectedResult.HasValue)
				{
					Assert.That(dateWithOffset, Is.GreaterThan(TestDateWithOffset), "DateTimeOffset max has failed");
					Assert.That(
						await (futureDateWithOffset.GetValueAsync(cancellationToken)),
						Is.GreaterThan(TestDateWithOffset),
						"Future DateTimeOffset max has failed");
				}
				else
				{
					Assert.That(dateWithOffset, Is.Null, "DateTimeOffset max has failed");
					Assert.That(await (futureDateWithOffset.GetValueAsync(cancellationToken)), Is.Null, "Future DateTimeOffset max has failed");
				}
			}
		}

		protected override async Task MinAsync<DC>(int? expectedResult, CancellationToken cancellationToken = default(CancellationToken))
		{
			using (var session = OpenSession())
			{
				var dcQuery = session.Query<DC>();
				var dateWithOffset = await (dcQuery.MinAsync(dc => dc.DateTimeOffset, cancellationToken));
				var futureDateWithOffset = dcQuery.ToFutureValue(qdc => qdc.Min(dc => dc.DateTimeOffset));
				if (expectedResult.HasValue)
				{
					Assert.That(dateWithOffset, Is.LessThan(TestDateWithOffset), "DateTimeOffset min has failed");
					Assert.That(await (futureDateWithOffset.GetValueAsync(cancellationToken)), Is.LessThan(TestDateWithOffset), "Future DateTimeOffset min has failed");
				}
				else
				{
					Assert.That(dateWithOffset, Is.Null, "DateTimeOffset min has failed");
					Assert.That(await (futureDateWithOffset.GetValueAsync(cancellationToken)), Is.Null, "Future DateTimeOffset min has failed");
				}
			}
		}
	}
}
