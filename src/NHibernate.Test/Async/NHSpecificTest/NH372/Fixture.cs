//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System;
using NUnit.Framework;

namespace NHibernate.Test.NHSpecificTest.NH372
{
	using System.Threading.Tasks;
	using System.Threading;
	[TestFixture]
	public class FixtureAsync : BugTestCase
	{
		protected bool isDynamic;

		public override string BugNumber
		{
			get { return "NH372"; }
		}

		private async Task ComponentFieldNotInserted_GenericAsync(System.Type type, CancellationToken cancellationToken = default(CancellationToken))
		{
			int id;

			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				BaseParent p = (BaseParent) Activator.CreateInstance(type);
				p.Component.FieldNotInserted = 10;
				await (session.SaveAsync(p, cancellationToken));

				await (tx.CommitAsync(cancellationToken));

				id = p.Id;
			}

			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				BaseParent p = (BaseParent) await (session.GetAsync(type, id, cancellationToken));

				Assert.AreEqual(0, p.Component.FieldNotInserted,
				                "Field should not have been inserted.");

				await (tx.CommitAsync(cancellationToken));
			}
		}

		[Test]
		public Task ComponentFieldNotInsertedAsync()
		{
			try
			{
				isDynamic = false;
				return ComponentFieldNotInserted_GenericAsync(typeof(Parent));
			}
			catch (Exception ex)
			{
				return Task.FromException<object>(ex);
			}
		}

		[Test]
		public Task ComponentFieldNotInserted_DynamicAsync()
		{
			try
			{
				isDynamic = true;
				return ComponentFieldNotInserted_GenericAsync(typeof(DynamicParent));
			}
			catch (Exception ex)
			{
				return Task.FromException<object>(ex);
			}
		}

		private async Task ComponentFieldNotUpdated_GenericAsync(System.Type type, CancellationToken cancellationToken = default(CancellationToken))
		{
			int id;
			int fieldInitialValue = 10;
			int fieldNewValue = 30;

			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				BaseParent p = (BaseParent) Activator.CreateInstance(type);
				p.Component.FieldNotUpdated = fieldInitialValue;
				await (session.SaveAsync(p, cancellationToken));

				await (tx.CommitAsync(cancellationToken));

				id = p.Id;
			}

			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				BaseParent p = (BaseParent) await (session.GetAsync(type, id, cancellationToken));

				Assert.AreEqual(fieldInitialValue, p.Component.FieldNotUpdated,
				                String.Format("Field should have initial inserted value of {0}.", fieldInitialValue));

				p.Component.FieldNotUpdated = fieldNewValue;
				p.Component.NormalField = 10;

				await (tx.CommitAsync(cancellationToken));
			}

			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				BaseParent p = (BaseParent) await (session.GetAsync(type, id, cancellationToken));

				Assert.AreEqual(fieldInitialValue, p.Component.FieldNotUpdated,
				                "Field should not have been updated.");

				await (tx.CommitAsync(cancellationToken));
			}
		}

		[Test]
		public Task ComponentFieldNotUpdatedAsync()
		{
			try
			{
				isDynamic = false;
				return ComponentFieldNotUpdated_GenericAsync(typeof(Parent));
			}
			catch (Exception ex)
			{
				return Task.FromException<object>(ex);
			}
		}

		[Test]
		public Task ComponentFieldNotUpdated_DynamicAsync()
		{
			try
			{
				isDynamic = true;
				return ComponentFieldNotUpdated_GenericAsync(typeof(DynamicParent));
			}
			catch (Exception ex)
			{
				return Task.FromException<object>(ex);
			}
		}

		private async Task SubComponentFieldNotInserted_GenericAsync(System.Type type, CancellationToken cancellationToken = default(CancellationToken))
		{
			int id;

			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				BaseParent p = (BaseParent) Activator.CreateInstance(type);
				p.Component.SubComponent.FieldNotInserted = 10;
				await (session.SaveAsync(p, cancellationToken));

				await (tx.CommitAsync(cancellationToken));

				id = p.Id;
			}

			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				BaseParent p = (BaseParent) await (session.GetAsync(type, id, cancellationToken));

				Assert.AreEqual(0, p.Component.SubComponent.FieldNotInserted,
				                "Field should not have been inserted.");

				await (tx.CommitAsync(cancellationToken));
			}
		}

		[Test]
		public Task SubComponentFieldNotInsertedAsync()
		{
			try
			{
				isDynamic = false;
				return SubComponentFieldNotInserted_GenericAsync(typeof(Parent));
			}
			catch (Exception ex)
			{
				return Task.FromException<object>(ex);
			}
		}

		[Test]
		public Task SubComponentFieldNotInserted_DynamicAsync()
		{
			try
			{
				isDynamic = false;
				return SubComponentFieldNotInserted_GenericAsync(typeof(DynamicParent));
			}
			catch (Exception ex)
			{
				return Task.FromException<object>(ex);
			}
		}

		private async Task SubComponentFieldNotUpdated_GenericAsync(System.Type type, CancellationToken cancellationToken = default(CancellationToken))
		{
			int id;
			int fieldInitialValue = 10;
			int fieldNewValue = 30;

			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				BaseParent p = (BaseParent) Activator.CreateInstance(type);
				p.Component.SubComponent.FieldNotUpdated = fieldInitialValue;
				await (session.SaveAsync(p, cancellationToken));

				await (tx.CommitAsync(cancellationToken));

				id = p.Id;
			}

			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				BaseParent p = (BaseParent) await (session.GetAsync(type, id, cancellationToken));

				Assert.AreEqual(fieldInitialValue, p.Component.SubComponent.FieldNotUpdated,
				                String.Format("Field should have initial inserted value of {0}.", fieldInitialValue));

				p.Component.SubComponent.FieldNotUpdated = fieldNewValue;
				p.Component.SubComponent.NormalField = 10;

				await (tx.CommitAsync(cancellationToken));
			}

			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				BaseParent p = (BaseParent) await (session.GetAsync(type, id, cancellationToken));

				Assert.AreEqual(fieldInitialValue, p.Component.SubComponent.FieldNotUpdated,
				                "Field should not have been updated.");

				await (tx.CommitAsync(cancellationToken));
			}
		}

		[Test]
		public Task SubComponentFieldNotUpdatedAsync()
		{
			try
			{
				isDynamic = false;
				return SubComponentFieldNotUpdated_GenericAsync(typeof(Parent));
			}
			catch (Exception ex)
			{
				return Task.FromException<object>(ex);
			}
		}

		[Test]
		public Task SubComponentFieldNotUpdated_DynamicAsync()
		{
			try
			{
				isDynamic = false;
				return SubComponentFieldNotUpdated_GenericAsync(typeof(DynamicParent));
			}
			catch (Exception ex)
			{
				return Task.FromException<object>(ex);
			}
		}

		protected override void OnTearDown()
		{
			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				if (isDynamic)
				{
					session.Delete("from DynamicParent");
				}
				else
				{
					session.Delete("from Parent");
				}
				tx.Commit();
			}
		}
	}
}