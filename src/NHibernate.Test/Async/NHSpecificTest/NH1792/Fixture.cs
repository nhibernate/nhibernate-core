//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System.Collections.Generic;
using NHibernate.Criterion;
using NUnit.Framework;

namespace NHibernate.Test.NHSpecificTest.NH1792
{
	using System.Threading.Tasks;
	using System.Threading;
	[TestFixture]
	public class FixtureAsync : BugTestCase
	{
		protected override void OnTearDown()
		{
			DeleteAll();
		}

		/// <summary>
		/// Deletes all the product entities from the persistence medium
		/// </summary>
		/// <param name="cancellationToken">A cancellation token that can be used to cancel the work</param>
		private async Task DeleteAllAsync(CancellationToken cancellationToken = default(CancellationToken))
		{
			using (ISession session = OpenSession())
			{
				using (ITransaction trans = session.BeginTransaction())
				{
					await (session.DeleteAsync("from Product", cancellationToken));
					await (trans.CommitAsync(cancellationToken));
				}
			}
		}

		/// <summary>
		/// Deletes all the product entities from the persistence medium
		/// </summary>
		private void DeleteAll()
		{
			using (ISession session = OpenSession())
			{
				using (ITransaction trans = session.BeginTransaction())
				{
					session.Delete("from Product");
					trans.Commit();
				}
			}
		}

		/// <summary>
		/// Creates some product enties to work with
		/// </summary>
		protected override void OnSetUp()
		{
			base.OnSetUp();

			using (ISession session = OpenSession())
			{
				using (ITransaction tx = session.BeginTransaction())
				{
					for (int i = 0; i < 10; i++)
					{
						var prod = new Product {Name = "Product" + i};

						session.Save(prod);
					}
					tx.Commit();
				}
			}
		}

		/// <summary>
		/// Verifies that a subquery created as a detached criteria with an order by 
		/// will produce valid sql when the main query does not contain an order by clause
		/// </summary>
		[Test]
		public async Task PageWithDetachedCriteriaSubqueryWithOrderByAsync()
		{
			//create the subquery
			DetachedCriteria subQuery =
				DetachedCriteria.For<Product>().SetProjection(Projections.Id()).AddOrder(Order.Desc("Name")).SetMaxResults(5);

			using (ISession session = OpenSession())
			{
				IList<Product> results =
					await (session.CreateCriteria<Product>().Add(Subqueries.PropertyIn("Id", subQuery)).Add(Restrictions.Gt("Id", 0)).
						SetMaxResults(3).ListAsync<Product>());

				Assert.AreEqual(3, results.Count);
			}
		}

		/// <summary>
		/// Verifies that a subquery created as a raw sql statement with an order by 
		/// will produce valid sql when the main query does not contain an order by clause
		/// </summary>
		[Test]
		public async Task PageWithRawSqlSubqueryWithOrderByAsync()
		{
			using (ISession session = OpenSession())
			{
				string top = "";
				if (Dialect.GetType().Name.StartsWith("MsSql"))
					top = "top 5";

				IList<Product> results =
					await (session.CreateCriteria<Product>().Add(
						Expression.Sql("{alias}.Id in (Select " + top + " p.Id from Product p order by Name)")).Add(Restrictions.Gt("Id", 0)).
						SetMaxResults(3).ListAsync<Product>());

				Assert.AreEqual(3, results.Count);
			}
		}
	}
}