//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System.Linq;
using NHibernate.Linq;
using NUnit.Framework;

namespace NHibernate.Test.NHSpecificTest.GH3263
{
	using System.Threading.Tasks;
	[TestFixture]
	public class ReuseFetchJoinFixtureAsync : BugTestCase
	{
		protected override void OnSetUp()
		{
			using var s = OpenSession();
			using var t = s.BeginTransaction();
			var em = new Employee() { Name = "x", OptionalInfo = new OptionalInfo() };
			em.OptionalInfo.Employee = em;
			s.Save(em);
			t.Commit();
		}
		protected override void OnTearDown()
		{
			using var session = OpenSession();
			using var transaction = session.BeginTransaction();
			session.CreateQuery("delete from System.Object").ExecuteUpdate();

			transaction.Commit();
		}

		[Test]
		public async Task ReuseJoinScalarSelectAsync()
		{
			using var session = OpenSession();
			await (session.Query<Employee>()
				.Fetch(x => x.OptionalInfo)
				.Where(x => x.OptionalInfo != null)
				.Select(x => new { x.OptionalInfo.Age })
				.ToListAsync());
		}

		[Test]
		public async Task ReuseJoinScalarSelectHqlAsync()
		{
			using var session = OpenSession();
			await (session.CreateQuery(
				"select x.OptionalInfo.Age " +
				"from Employee x " +
				"fetch x.OptionalInfo " +
				"where x.OptionalInfo != null ").ListAsync());

		}

		[Test]
		public async Task ReuseJoinScalarSelectHql2Async()
		{
			using var session = OpenSession();
			await (session.CreateQuery(
				"select x.OptionalInfo.Age " +
				"from Employee x " +
				"join fetch x.OptionalInfo o " +
				"where o != null ").ListAsync());
		}

		[Test]
		public async Task ReuseJoinScalarSelectHql3Async()
		{
			using var session = OpenSession();
			await (session.CreateQuery(
				"select x.OptionalInfo.Age from Employee x " +
				"join fetch x.OptionalInfo " +
				"where x.OptionalInfo != null ").ListAsync());
		}

		[Test]
		public async Task ReuseJoinEntityAndScalarSelectAsync()
		{
			using var session = OpenSession();
			using var sqlLog = new SqlLogSpy();

			var x = await (session.Query<Employee>()
				.Fetch(x => x.OptionalInfo)
				.Where(x => x.OptionalInfo != null)
				.Select(x => new { x, x.OptionalInfo.Age })
				.FirstAsync());

			Assert.That(sqlLog.Appender.GetEvents().Length, Is.EqualTo(1));
			Assert.That(NHibernateUtil.IsInitialized(x.x.OptionalInfo), Is.True);
		}
	}
}
