//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using NHibernate.AdoNet;
using NHibernate.Cfg;
using NUnit.Framework;

namespace NHibernate.Test.NHSpecificTest.NH3010
{
	using System.Threading.Tasks;
	[TestFixture]
	public class FixtureWithNoBatcherAsync : BugTestCase
	{
		protected override void Configure(Configuration configuration)
		{
			configuration.DataBaseIntegration(x =>
			{
				x.BatchSize = 0;
				x.Batcher<NonBatchingBatcherFactory>();
			});
		}

		protected override void OnSetUp()
		{
			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				var parent = new Parent();
				var childOne = new Child();
				parent.Childs.Add(childOne);
				session.Save(parent);

				tx.Commit();
			}
		}

		protected override void OnTearDown()
		{
			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				session.Delete("from Child");
				session.Delete("from Parent");
				tx.Commit();
			}
		}

		// Test case from NH-2527
		[Test]
		public async Task DisposedCommandShouldNotBeReusedAfterRemoveAtAndInsertAsync()
		{
			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				var parent = await (session.CreateCriteria<Parent>().UniqueResultAsync<Parent>());

				Child childOne = parent.Childs[0];

				var childTwo = new Child();
				parent.Childs.Add(childTwo);

				Child childToMove = parent.Childs[1];
				parent.Childs.RemoveAt(1);
				parent.Childs.Insert(0, childToMove);

				Assert.DoesNotThrowAsync(() => tx.CommitAsync());

				Assert.That(childTwo.Id, Is.EqualTo(parent.Childs[0].Id));
				Assert.That(childOne.Id, Is.EqualTo(parent.Childs[1].Id));
			}
		}

		// Test case from NH-1477
		[Test]
		public async Task DisposedCommandShouldNotBeReusedAfterClearAndAddAsync()
		{
			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				var parent = await (session.CreateCriteria<Parent>().UniqueResultAsync<Parent>());

				parent.Childs.Clear();

				var childOne = new Child();
				parent.Childs.Add(childOne);

				var childTwo = new Child();
				parent.Childs.Add(childTwo);

				Assert.DoesNotThrowAsync(() => tx.CommitAsync());

				Assert.That(childOne.Id, Is.EqualTo(parent.Childs[0].Id));
				Assert.That(childTwo.Id, Is.EqualTo(parent.Childs[1].Id));
			}
		}
	}
}
