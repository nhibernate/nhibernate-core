//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System.Linq;
using NHibernate.Linq;
using NUnit.Framework;

namespace NHibernate.Test.NHSpecificTest.NH3641
{
	using System.Threading.Tasks;
	[TestFixture]
	public class TestFixtureAsync : BugTestCase
	{
		protected override void OnSetUp()
		{
			using (var session = OpenSession())
			using (var tx = session.BeginTransaction())
			{
				var child = new Entity {Id = 1, Flag = true};
				var parent = new Entity {Id = 2, ChildInterface = child, ChildConcrete = child};

				session.Save(child);
				session.Save(parent);

				tx.Commit();
			}
		}

		protected override void OnTearDown()
		{
			using (var session = OpenSession())
			using (var tx = session.BeginTransaction())
			{
				DeleteAll<Entity>(session);
				tx.Commit();
			}
		}

		private static void DeleteAll<T>(ISession session)
		{
			session.CreateQuery("delete from " + typeof(T).Name + " where ChildInterface is not null").ExecuteUpdate();
			session.CreateQuery("delete from " + typeof(T).Name).ExecuteUpdate();
		}

		[Test]
		public async Task TrueOrChildPropertyConcreteAsync()
		{
			using (var session = OpenSession())
			{
				var result = await (session.Query<IEntity>()
					.Where(x => x.ChildConcrete == null || x.ChildConcrete.Flag)
					.ToListAsync());
				Assert.That(result, Has.Count.EqualTo(2));
			}
		}

		[Test]
		public async Task TrueOrChildPropertyInterfaceAsync()
		{
			using (var session = OpenSession())
			{
				var result = await (session.Query<IEntity>()
					.Where(x => x.ChildInterface == null || ((Entity) x.ChildInterface).Flag)
					.ToListAsync());
				Assert.That(result, Has.Count.EqualTo(2));
			}
		}
	}
}
