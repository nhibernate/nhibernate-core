//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System;
using NHibernate.Cfg;
using NUnit.Framework;

namespace NHibernate.Test.NHSpecificTest.NH750
{
	using System.Threading.Tasks;
	[TestFixture]
	public class FixtureAsync : BugTestCase
	{
		protected override void OnTearDown()
		{
			using (ISession s = Sfi.OpenSession())
			{
				s.Delete("from Device");
				s.Delete("from Drive");
				s.Flush();
			}
		}

		protected override string CacheConcurrencyStrategy
		{
			get { return null; }
		}

		protected override void Configure(Configuration configuration)
		{
			configuration.SetProperty(Cfg.Environment.UseSecondLevelCache, "false");
			base.Configure(configuration);
		}

		[Test]
		public async Task DeviceOfDriveAsync()
		{
			int[] dvSavedId = new int[2];
			Drive dr1 = new Drive("Drive 1");
			Drive dr2 = new Drive("Drive 2");
			Drive dr3 = new Drive("Drive 3");
			Device dv1 = new Device("Device 1");
			Device dv2 = new Device("Device 2");
			using (ISession s = Sfi.OpenSession())
			{
				await (s.SaveAsync(dr1));
				await (s.SaveAsync(dr2));
				await (s.SaveAsync(dr3));
				dvSavedId[0] = (int) await (s.SaveAsync(dv1));
				dvSavedId[1] = (int) await (s.SaveAsync(dv2));
				await (s.FlushAsync());
			}

			dv1.Drives.Add(dr1);
			dv1.Drives.Add(dr2);
			dv2.Drives.Add(dr1);
			dv2.Drives.Add(dr3);
			using (ISession s = Sfi.OpenSession())
			{
				dvSavedId[0] = (int) await (s.SaveAsync(dv1));
				dvSavedId[1] = (int) await (s.SaveAsync(dv2));
				await (s.FlushAsync());
			}
			dv1 = null;
			dv2 = null;
			using (ISession s = Sfi.OpenSession())
			{
				await (s.DeleteAsync(dr3));
				await (s.FlushAsync());
				dv1 = (Device) await (s.LoadAsync(typeof(Device), dvSavedId[0]));
				dv2 = (Device) await (s.LoadAsync(typeof(Device), dvSavedId[1]));
			}
			Assert.AreEqual(2, dv1.Drives.Count);
			// Verify one is missing
			Assert.AreEqual(1, dv2.Drives.Count);
			// Verify dv1 unchanged
			Assert.IsTrue(dv1.Drives.Contains(dr1));
			Assert.IsTrue(dv1.Drives.Contains(dr2));

			// Verify dv2
			Assert.IsTrue(dv2.Drives.Contains(dr1));
			Assert.IsFalse(dv2.Drives.Contains(dr3));

			//Make sure that flush didn't touch not-found="ignore" records for not modified collection
			using (var s = Sfi.OpenSession())
			using (var t = s.BeginTransaction())
			{
				dv2 = await (s.GetAsync<Device>(dv2.Id));
				await (s.FlushAsync());
				await (t.CommitAsync());
			}

			await (VerifyResultAsync(expectedInCollection: 1, expectedInDb: 2, msg: "not modified collection"));

			//Many-to-many clears collection and recreates it so not-found ignore records are lost
			using (var s = Sfi.OpenSession())
			using (var t = s.BeginTransaction())
			{
				dv2 = await (s.GetAsync<Device>(dv2.Id));
				dv2.Drives.Add(dr2);
				await (t.CommitAsync());
			}

			await (VerifyResultAsync(2, 2, msg: "modified collection"));

			async Task VerifyResultAsync(int expectedInCollection, int expectedInDb, string msg)
			{
				using (var s = Sfi.OpenSession())
				{
					var realCound = Convert.ToInt32(
						await (s.CreateSQLQuery("select count(*) from DriveOfDevice where DeviceId = :id ")
						.SetParameter("id", dv2.Id)
						.UniqueResultAsync<object>()));
					dv2 = await (s.GetAsync<Device>(dv2.Id));

					Assert.That(dv2.Drives.Count, Is.EqualTo(expectedInCollection), msg);
					Assert.That(realCound, Is.EqualTo(expectedInDb), msg);
				}
			}
		}
	}
}
