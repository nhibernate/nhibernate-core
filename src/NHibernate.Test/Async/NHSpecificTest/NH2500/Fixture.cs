//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

using NHibernate.Cfg.MappingSchema;
using NHibernate.Linq;
using NHibernate.Mapping.ByCode;

using NUnit.Framework;

namespace NHibernate.Test.NHSpecificTest.NH2500
{
    using System.Threading.Tasks;

    [TestFixture]
    public class FixtureAsync : TestCaseMappingByCode
    {
        protected override HbmMapping GetMappings()
        {
            var mapper = new ConventionModelMapper();
            mapper.BeforeMapClass += (mi, t, x) => x.Id(map => map.Generator(Generators.Guid));
            return mapper.CompileMappingFor(new[] { typeof(Foo) });
        }

        protected override void OnSetUp()
        {
            base.OnSetUp();

            using (ISession session = Sfi.OpenSession())
            using (ITransaction transaction = session.BeginTransaction())
            {
                session.Persist(new Foo { Name = "Banana" });
                session.Persist(new Foo { Name = "Egg" });
                transaction.Commit();
            }
        }

        protected override void OnTearDown()
        {
            using (ISession session = Sfi.OpenSession())
            using (ITransaction transaction = session.BeginTransaction())
            {
                session.CreateQuery("delete from Foo").ExecuteUpdate();
                transaction.Commit();
            }

            base.OnTearDown();
        }

		private int count;
		
		[Test]
        public async Task TestLinqProjectionExpressionDoesntCacheParametersAsync()
        {
            using (ISession session = Sfi.OpenSession())
            using (ITransaction transaction = session.BeginTransaction())
            {
            	this.count = 1;

            	var foos1 = await (session.Query<Foo>()
            		.Where(x => x.Name == "Banana")
            		.Select(x => new
            		{
            			x.Name,
            			count,
            			User = "abc"
            		}).FirstAsync());

            	this.count = 2;

            	var foos2 = await (session.Query<Foo>()
            		.Where(x => x.Name == "Egg")
            		.Select(x => new
            		{
            			x.Name,
            			count,
            			User = "def"
            		}).FirstAsync());

				Assert.AreEqual(1, foos1.count);
				Assert.AreEqual(2, foos2.count);
				Assert.AreEqual("abc", foos1.User);
				Assert.AreEqual("def", foos2.User);

                await (transaction.CommitAsync());
            }
        }
    }
}
