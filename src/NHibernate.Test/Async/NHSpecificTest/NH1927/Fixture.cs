//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System;
using NHibernate.Criterion;
using NHibernate.SqlCommand;
using NUnit.Framework;

namespace NHibernate.Test.NHSpecificTest.NH1927
{
	using System.Threading.Tasks;
	using System.Threading;
	[TestFixture]
	public class FixtureAsync : BugTestCase
	{
        private static readonly DateTime MAX_DATE = new DateTime(3000, 1, 1);
        private static readonly DateTime VALID_DATE = new DateTime(2000, 1, 1);

        protected override void OnSetUp()
        {
            base.OnSetUp();
            using (ISession session = OpenSession())
            {
                using (ITransaction tx = session.BeginTransaction())
                {
                    var joe = new Customer() {ValidUntil = MAX_DATE};
                    session.Save(joe);

                    tx.Commit();
                }
            }
        }

        protected override void OnTearDown()
        {
            using (ISession session = OpenSession())
            {
                using (ITransaction tx = session.BeginTransaction())
                {
                    session.Delete("from Invoice");
                    session.Delete("from Customer");
                    tx.Commit();
                }
            }
            base.OnTearDown();
        }

	    private delegate Customer QueryFactoryFunc(ISession session);

        private async Task TestQueryAsync(QueryFactoryFunc queryFactoryFunc, CancellationToken cancellationToken = default(CancellationToken))
        {
            // test without filter
            using (ISession session = OpenSession())
            using (ITransaction tx = session.BeginTransaction())
            {
                Assert.That(queryFactoryFunc(session), Is.Not.Null, "failed with filter off");
                await (tx.CommitAsync(cancellationToken));
            }

            // test with the validity filter
            using (ISession session = OpenSession())
            using (ITransaction tx = session.BeginTransaction())
            {
                session.EnableFilter("validity").SetParameter("date", VALID_DATE);
                Assert.That(queryFactoryFunc(session), Is.Not.Null, "failed with filter on");
                await (tx.CommitAsync(cancellationToken));
            }

        }

        [Test]
        public Task CriteriaWithEagerFetchAsync()
        {
            return TestQueryAsync(s => s.CreateCriteria(typeof (Customer))
				.SetFetchMode("Invoices", FetchMode.Eager)
				.UniqueResult<Customer>()
				);
        }

        [Test]
        public Task CriteriaWithoutEagerFetchAsync()
        {
            return TestQueryAsync(s => s
				.CreateCriteria(typeof(Customer))
				.UniqueResult<Customer>()
				);
        }

        [Test]
        public Task HqlWithEagerFetchAsync()
        {
            return TestQueryAsync(s => s.CreateQuery(@"
                    select c
                    from Customer c
                        left join fetch c.Invoices"
                    )
                    .UniqueResult<Customer>());
        }
        
        [Test]
        public Task HqlWithoutEagerFetchAsync()
        {
            return TestQueryAsync(s => s.CreateQuery(@"
                    select c
                    from Customer c"
                    )
                    .UniqueResult<Customer>());
        }
    }
}
