//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System.Collections.Generic;
using NHibernate.Cfg;
using NHibernate.Dialect;
using NUnit.Framework;

namespace NHibernate.Test.NHSpecificTest.NH1612
{
	using System.Threading.Tasks;
	using System.Threading;
	[TestFixture]
	public class NativeSqlCollectionLoaderFixtureAsync : BugTestCase
	{
		protected virtual bool WithQueryCache => false;

		protected override void Configure(Configuration configuration)
		{
			base.Configure(configuration);
			configuration.SetProperty(Environment.UseQueryCache, WithQueryCache.ToString());
		}

		#region Tests - <return-join>

		[Test]
		public async Task LoadElementsWithWithSimpleHbmAliasInjectionAsync()
		{
			string[] routes = CreateRoutes();
			Country country = await (LoadCountryWithNativeSQLAsync(CreateCountry(routes), "LoadCountryRoutesWithSimpleHbmAliasInjection"));

			Assert.That(country, Is.Not.Null);
			Assert.That(country.Routes, Is.EquivalentTo(routes));
		}

		[Test]
		public async Task LoadElementsWithExplicitColumnMappingsAsync()
		{
			string[] routes = CreateRoutes();
			Country country = await (LoadCountryWithNativeSQLAsync(CreateCountry(routes), "LoadCountryRoutesWithCustomAliases"));
			Assert.That(country, Is.Not.Null);
			Assert.That(country.Routes, Is.EquivalentTo(routes));
		}

		[Test]
		public async Task LoadCompositeElementsWithWithSimpleHbmAliasInjectionAsync()
		{
			IDictionary<int, AreaStatistics> stats = CreateStatistics();
			Country country = await (LoadCountryWithNativeSQLAsync(CreateCountry(stats), "LoadAreaStatisticsWithSimpleHbmAliasInjection"));

			Assert.That(country, Is.Not.Null);
			Assert.That(country.Statistics.Keys, Is.EquivalentTo(stats.Keys), "Keys");
			Assert.That(country.Statistics.Values, Is.EquivalentTo(stats.Values), "Elements");
		}

		[Test]
		public async Task LoadCompositeElementsWithWithComplexHbmAliasInjectionAsync()
		{
			IDictionary<int, AreaStatistics> stats = CreateStatistics();
			Country country = await (LoadCountryWithNativeSQLAsync(CreateCountry(stats), "LoadAreaStatisticsWithComplexHbmAliasInjection"));

			Assert.That(country, Is.Not.Null);
			Assert.That(country.Statistics.Keys, Is.EquivalentTo(stats.Keys), "Keys");
			Assert.That(country.Statistics.Values, Is.EquivalentTo(stats.Values), "Elements");
		}

		[Test]
		public async Task LoadCompositeElementsWithWithCustomAliasesAsync()
		{
			IDictionary<int, AreaStatistics> stats = CreateStatistics();
			Country country = await (LoadCountryWithNativeSQLAsync(CreateCountry(stats), "LoadAreaStatisticsWithCustomAliases"));

			Assert.That(country, Is.Not.Null);
			Assert.That(country.Statistics.Keys, Is.EquivalentTo(stats.Keys), "Keys");
			Assert.That(country.Statistics.Values, Is.EquivalentTo(stats.Values), "Elements");
		}

		[Test]
		public async Task LoadEntitiesWithWithSimpleHbmAliasInjectionAsync()
		{
			City[] cities = CreateCities();
			Country country = CreateCountry(cities);
			await (SaveAsync(country));
			using (ISession session = OpenSession())
			{
				var query = session.GetNamedQuery("LoadCountryCitiesWithSimpleHbmAliasInjection")
								   .SetString("country_code", country.Code)
								   .SetCacheable(WithQueryCache);
				var c = await (query.UniqueResultAsync<Country>());
				if (WithQueryCache)
					// Re-get it for obtaining it from cache.
					c = await (query.UniqueResultAsync<Country>());
				Assert.That(c, Is.Not.Null);
				Assert.That(c.Cities, Is.EquivalentTo(cities));
			}
		}

		[Test]
		public async Task LoadEntitiesWithComplexHbmAliasInjectionAsync()
		{
			City[] cities = CreateCities();
			Country country = CreateCountry(cities);
			await (SaveAsync(country));
			using (ISession session = OpenSession())
			{
				var query = session.GetNamedQuery("LoadCountryCitiesWithComplexHbmAliasInjection")
								   .SetString("country_code", country.Code)
								   .SetCacheable(WithQueryCache);
				var c = await (query.UniqueResultAsync<Country>());
				if (WithQueryCache)
					// Re-get it for obtaining it from cache.
					c = await (query.UniqueResultAsync<Country>());
				Assert.That(c, Is.Not.Null);
				Assert.That(c.Cities, Is.EquivalentTo(cities));
			}
		}

		[Test]
		public async Task LoadEntitiesWithExplicitColumnMappingsAsync()
		{
			City[] cities = CreateCities();
			Country country = CreateCountry(cities);
			await (SaveAsync(country));
			using (ISession session = OpenSession())
			{
				var query = session.GetNamedQuery("LoadCountryCitiesWithCustomAliases")
								   .SetString("country_code", country.Code)
								   .SetCacheable(WithQueryCache);
				var c = await (query.UniqueResultAsync<Country>());
				if (WithQueryCache)
					// Re-get it for obtaining it from cache.
					c = await (query.UniqueResultAsync<Country>());
				Assert.That(c, Is.Not.Null);
				Assert.That(c.Cities, Is.EquivalentTo(cities));
			}
		}

		[Test]
		public void NativeQueryWithUnresolvedHbmAliasInjectionAsync()
		{
			IDictionary<int, AreaStatistics> stats = CreateStatistics();
			Assert.That(
				() => LoadCountryWithNativeSQLAsync(CreateCountry(stats), "LoadAreaStatisticsWithFaultyHbmAliasInjection"),
				Throws.InstanceOf<QueryException>());
		}

		private async Task<Country> LoadCountryWithNativeSQLAsync(Country country, string queryName, CancellationToken cancellationToken = default(CancellationToken))
		{
			// Ensure country is saved and session cache is empty to force from now on the reload of all 
			// persistence objects from the database.
			using (ISession session = OpenSession())
			{
				using (ITransaction tx = session.BeginTransaction())
				{
					await (session.SaveAsync(country, cancellationToken));
					await (tx.CommitAsync(cancellationToken));
				}
			}
			using (ISession session = OpenSession())
			{
				var query = session.GetNamedQuery(queryName).SetString("country_code", country.Code).SetCacheable(WithQueryCache);
				var result = await (query.UniqueResultAsync<Country>(cancellationToken));
				if (WithQueryCache)
					// Get it from cache by re-executing.
					result = await (query.UniqueResultAsync<Country>(cancellationToken));
				return result;
			}
		}

		#endregion

		#region Tests - <load-collection>

		[Test]
		public async Task LoadElementCollectionWithCustomLoaderAsync()
		{
			Assume.That(WithQueryCache, Is.False, "This test does not use a cacheable query.");
			string[] routes = CreateRoutes();
			Country country = CreateCountry(routes);
			await (SaveAsync(country));
			using (ISession session = OpenSession())
			{
				var c = await (session.GetAsync<Country>(country.Code));
				Assert.That(c, Is.Not.Null, "country");
				Assert.That(c.Routes, Is.EquivalentTo(routes), "country.Routes");
			}
		}

		[Test]
		public async Task LoadCompositeElementCollectionWithCustomLoaderAsync()
		{
			Assume.That(WithQueryCache, Is.False, "This test does not use a cacheable query.");
			IDictionary<int, AreaStatistics> stats = CreateStatistics();
			Country country = CreateCountry(stats);
			await (SaveAsync(country));
			using (ISession session = OpenSession())
			{
				var a = await (session.GetAsync<Area>(country.Code));
				Assert.That(a, Is.Not.Null, "area");
				Assert.That(a.Statistics.Keys, Is.EquivalentTo(stats.Keys), "area.Keys");
				Assert.That(a.Statistics.Values, Is.EquivalentTo(stats.Values), "area.Elements");
			}
		}

		[Test]
		public async Task LoadEntityCollectionWithCustomLoaderAsync()
		{
			Assume.That(WithQueryCache, Is.False, "This test does not use a cacheable query.");
			City[] cities = CreateCities();
			Country country = CreateCountry(cities);
			await (SaveAsync(country));
			using (ISession session = OpenSession())
			{
				var c = await (session.GetAsync<Country>(country.Code));

				Assert.That(c, Is.Not.Null, "country");
				Assert.That(c.Cities, Is.EquivalentTo(cities), "country.Cities");
			}
		}

		private async Task SaveAsync<TArea>(TArea area, CancellationToken cancellationToken = default(CancellationToken)) where TArea : Area
		{
			using (ISession session = OpenSession())
			{
				using (ITransaction tx = session.BeginTransaction())
				{
					await (session.SaveAsync(area, cancellationToken));
					await (tx.CommitAsync(cancellationToken));
				}
			}
		}

		#endregion

		#region Tests - corner cases to verify backwards compatibility of NH-1612 patch

		[Test]
		public async Task NativeUpdateQueryWithoutResultsAsync()
		{
			Assume.That(Dialect, Is.InstanceOf<MsSql2000Dialect>(), "This does not apply to {0}", Dialect);
			Assume.That(WithQueryCache, Is.False, "This test does not use a cacheable query.");
			using (ISession session = OpenSession())
			{
				using (ITransaction tx = session.BeginTransaction())
				{
					await (session.GetNamedQuery("UpdateQueryWithoutResults").ExecuteUpdateAsync());
					await (tx.CommitAsync());
				}
			}
		}

		[Test]
		public async Task NativeScalarQueryWithoutResultsAsync()
		{
			Assume.That(Dialect, Is.InstanceOf<MsSql2000Dialect>(), "This does not apply to {0}", Dialect);
			Assume.That(WithQueryCache, Is.False, "This test does not use a cacheable query.");
			using (ISession session = OpenSession())
			{
				using (ITransaction tx = session.BeginTransaction())
				{
					// Native SQL Query outcome is not validated against <return-*> 
					// resultset declarations.
					await (session.GetNamedQuery("ScalarQueryWithDefinedResultsetButNoResults").ExecuteUpdateAsync());
					await (tx.CommitAsync());
				}
			}
		}

		[Test]
		public async Task NativeScalarQueryWithUndefinedResultsetAsync()
		{
			if (!(Dialect is MsSql2000Dialect))
			{
				Assert.Ignore("This does not apply to {0}", Dialect);
			}
			using (ISession session = OpenSession())
			{
				using (session.BeginTransaction())
				{
					// Native SQL Query outcome is not validated against <return-*> 
					// resultset declarations.
					var query = session.GetNamedQuery("ScalarQueryWithUndefinedResultset")
									   .SetReadOnly(WithQueryCache);
					var result = await (query.UniqueResultAsync<int>());
					if (WithQueryCache)
						result = await (query.UniqueResultAsync<int>());
					Assert.That(result, Is.EqualTo(1));
				}
			}
		}

		[Test]
		public async Task NativeScalarQueryWithDefinedResultsetAsync()
		{
			if (!(Dialect is MsSql2000Dialect))
			{
				Assert.Ignore("This does not apply to {0}", Dialect);
			}
			using (ISession session = OpenSession())
			{
				using (session.BeginTransaction())
				{
					// Native SQL Query outcome is not validated against <return-*> 
					// resultset declarations.
					var query = session.GetNamedQuery("ScalarQueryWithDefinedResultset")
									   .SetReadOnly(WithQueryCache);
					var result = await (query.UniqueResultAsync<int>());
					if (WithQueryCache)
						result = await (query.UniqueResultAsync<int>());
					Assert.That(result, Is.EqualTo(2));
				}
			}
		}

		#endregion

		#region cleanup

		protected override void OnTearDown()
		{
			using (var session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				session.Delete("from Person");
				session.Delete("from City");
				session.Delete("from Country");
				tx.Commit();
			}
		}

		#endregion

		#region Factory methods

		private static Country CreateCountry()
		{
			const string COUNTRY_CODE = "WL";
			const string COUNTRY_NAME = "Wonderland";
			return new Country(COUNTRY_CODE, COUNTRY_NAME);
		}

		private static Country CreateCountry(params string[] routes)
		{
			Country country = CreateCountry();
			foreach (var route in routes)
			{
				country.Routes.Add(route);
			}
			return country;
		}

		private static Country CreateCountry(params City[] cities)
		{
			Country country = CreateCountry();
			foreach (var city in cities)
			{
				city.SetParent(country);
			}
			return country;
		}

		private static Country CreateCountry(IDictionary<int, AreaStatistics> statistics)
		{
			Country country = CreateCountry();
			foreach (var pair in statistics)
			{
				country.Statistics.Add(pair);
			}
			return country;
		}

		private static string[] CreateRoutes()
		{
			return new[] { "Yellow Road", "Muddy Path" };
		}

		private static City[] CreateCities()
		{
			return new[] { new City("EMR", "Emerald City"), new City("GLD", "Golden Town"), new City("NTH", "North End") };
		}

		private static IDictionary<int, AreaStatistics> CreateStatistics()
		{
			var archimedes = new Person("Archimedes");
			var archibald = new Person("Archibald");
			var amy = new Person("Amy");
			return new Dictionary<int, AreaStatistics>
					   {
						   {
							   1850,
							   new AreaStatistics {CitizenCount = 10000, GDP = new MonetaryValue("USD", 20000), Reporter = archimedes}
							   },
						   {
							   1900,
							   new AreaStatistics {CitizenCount = 20000, GDP = new MonetaryValue("USD", 50000), Reporter = archibald}
							   },
						   {1950, new AreaStatistics {CitizenCount = 40000, GDP = new MonetaryValue("USD", 125000)}},
						   {2000, new AreaStatistics {CitizenCount = 80000, GDP = new MonetaryValue("USD", 500000), Reporter = amy}},
					   };
		}

		#endregion
	}

	[TestFixture]
	public class CachedNativeSqlCollectionLoaderFixtureAsync : NativeSqlCollectionLoaderFixtureAsync
	{
		protected override bool WithQueryCache => true;
	}
}
