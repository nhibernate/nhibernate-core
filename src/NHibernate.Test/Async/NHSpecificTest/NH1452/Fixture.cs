//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using NHibernate.Cfg;
using NHibernate.Criterion;
using NUnit.Framework;

namespace NHibernate.Test.NHSpecificTest.NH1452
{
	using System.Threading.Tasks;
	[TestFixture]
	public class FixtureAsync : BugTestCase
	{
		protected override void Configure(Configuration configuration)
		{
			base.Configure(configuration);
			configuration.SetProperty(Environment.FormatSql, "false");
		}

		/// <summary>
		/// push some data into the database
		/// Really functions as a save test also 
		/// </summary>
		protected override void OnSetUp()
		{
			using (var session = OpenSession())
			using (var tran = session.BeginTransaction())
			{
				session.Save(new Product
					{
						ProductId = "XO1234",
						Id = 1,
						Name = "Some product",
						Description = "Very good"
					});

				session.Save(new Product
					{
						ProductId = "XO54321",
						Id = 2,
						Name = "Other product",
						Description = "Very bad"
					});

				tran.Commit();
			}
		}

		protected override void OnTearDown()
		{
			base.OnTearDown();

			using (var session = OpenSession())
			using (var tran = session.BeginTransaction())
			{
				session.Delete("from Product");
				tran.Commit();
			}
		}

		[Test]
		public async Task Delete_single_recordAsync()
		{
			using (var session = OpenSession())
			{
				var product = new Product
					{
						ProductId = "XO1111",
						Id = 3,
						Name = "Test",
						Description = "Test"
					};

				await (session.SaveAsync(product));

				await (session.FlushAsync());

				await (session.DeleteAsync(product));
				await (session.FlushAsync());

				session.Clear();

				//try to query for this product
				product = await (session.CreateCriteria(typeof (Product))
								 .Add(Restrictions.Eq("ProductId", "XO1111"))
								 .UniqueResultAsync<Product>());

				Assert.That(product, Is.Null);
			}
		}

		[Test]
		public async Task Query_recordsAsync()
		{
			using (var sqlLog = new SqlLogSpy())
			using (var session = OpenSession())
			{
				var product = await (session.CreateCriteria(typeof (Product))
									 .Add(Restrictions.Eq("ProductId", "XO1234"))
									 .UniqueResultAsync<Product>());

				Assert.That(product, Is.Not.Null);
				Assert.That(product.Description, Is.EqualTo("Very good"));

				var log = sqlLog.GetWholeLog();
				//needs to be joining on the Id column not the productId
				Assert.That(log.Contains("inner join ProductLocalized this_1_ on this_.Id=this_1_.Id"), Is.True);
			}
		}

		[Test]
		public async Task Update_recordAsync()
		{
			using (var session = OpenSession())
			{
				var product = await (session.CreateCriteria(typeof (Product))
									 .Add(Restrictions.Eq("ProductId", "XO1234"))
									 .UniqueResultAsync<Product>());

				Assert.That(product, Is.Not.Null);

				product.Name = "TestValue";
				product.Description = "TestValue";

				await (session.FlushAsync());
				session.Clear();

				//pull again
				product = await (session.CreateCriteria(typeof (Product))
								 .Add(Restrictions.Eq("ProductId", "XO1234"))
								 .UniqueResultAsync<Product>());

				Assert.That(product, Is.Not.Null);
				Assert.That(product.Name, Is.EqualTo("TestValue"));
				Assert.That(product.Description, Is.EqualTo("TestValue"));
			}
		}
	}
}
