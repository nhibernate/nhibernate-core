//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System.Diagnostics;
using NHibernate.Criterion;
using NUnit.Framework;

namespace NHibernate.Test.NHSpecificTest.CriteriaFromHql
{
	using System.Collections;
	using System.Threading.Tasks;
	using System.Threading;

	[TestFixture]
	public class FixtureAsync : TestCase
	{

		protected override IList Mappings
		{
			get { return new string[] { "NHSpecificTest.CriteriaFromHql.Mappings.hbm.xml" }; }
		}

		protected override string MappingsAssembly
		{
			get { return "NHibernate.Test"; }
		}

		[Test]
		public async Task UsingCriteriaAndHqlAsync()
		{
			await (CreateDataAsync());

			using (SqlLogSpy spy = new SqlLogSpy())
			using (ISession session = Sfi.OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				Person result = await (session.CreateQuery(@"
select p from Person p 
join fetch p.Children c 
join fetch c.Children gc
where p.Parent is null")
					.UniqueResultAsync<Person>());

				string hqlQuery = spy.Appender.GetEvents()[0].MessageObject.ToString();
				Debug.WriteLine("HQL: " + hqlQuery);
				Assertions(result);
			}

			using (SqlLogSpy spy = new SqlLogSpy())
			using (ISession session = Sfi.OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				Person result = await (session.CreateCriteria(typeof(Person))
					.Add(Restrictions.IsNull("Parent"))
					.SetFetchMode("Children", FetchMode.Join)
					.SetFetchMode("Children.Children", FetchMode.Join)
					.UniqueResultAsync<Person>());
				string criteriaQuery = spy.Appender.GetEvents()[0].MessageObject.ToString();
				Debug.WriteLine("Criteria: " + criteriaQuery);
				Assertions(result);
			}

			await (DeleteDataAsync());
		}

		private async Task DeleteDataAsync(CancellationToken cancellationToken = default(CancellationToken))
		{
			using (ISession session = Sfi.OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				await (session.DeleteAsync("from Person", cancellationToken));
				await (tx.CommitAsync(cancellationToken));
			}
		}

		private async Task CreateDataAsync(CancellationToken cancellationToken = default(CancellationToken))
		{
			using (ISession session = Sfi.OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				Person root = new Person();
				await (session.SaveAsync(root, cancellationToken));
				for (int i = 0; i < 2; i++)
				{
					Person child = new Person();
					root.Children.Add(child);
					child.Parent = root;
					await (session.SaveAsync(child, cancellationToken));
					for (int j = 0; j < 3; j++)
					{
						Person child2 = new Person();
						child2.Parent = child;
						child.Children.Add(child2);
						await (session.SaveAsync(child2, cancellationToken));
					}
				}
				await (tx.CommitAsync(cancellationToken));
			}
		}

		private static void Assertions(Person p)
		{
			Assert.IsTrue(NHibernateUtil.IsInitialized(p.Children));
			Assert.AreEqual(2, p.Children.Count);
			foreach (Person child in p.Children)
			{
				Assert.IsTrue(NHibernateUtil.IsInitialized(child));
				Assert.IsTrue(NHibernateUtil.IsInitialized(child.Children));
				Assert.AreEqual(3, child.Children.Count);
			}
		}
	}
}
