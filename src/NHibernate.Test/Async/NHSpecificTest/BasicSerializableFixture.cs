//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System;
using System.Collections;
using NHibernate.DomainModel.NHSpecific;
using NUnit.Framework;

namespace NHibernate.Test.NHSpecificTest
{
	using System.Threading.Tasks;
	/// <summary>
	/// TestFixture for <c>type="Serializable"</c> in use by classes.  It test a Property
	/// that is mapped specifically by <c>type="Serializable"</c> and another Property
	/// whose type is a class that is serializable.
	/// </summary>
	[TestFixture]
	public class BasicSerializableFixtureAsync : TestCase
	{
		protected override string[] Mappings
		{
			get { return new string[] {"NHSpecific.BasicSerializable.hbm.xml"}; }
		}

		/// <summary>
		/// This contains portions of FumTest.CompositeIDs that deal with <c>type="Serializable"</c>
		/// and replacements Foo.NullBlob, and Foo.Blob.
		/// </summary>
		[Test]
		public async Task TestCRUDAsync()
		{
			ISession s = OpenSession();
			BasicSerializable ser = new BasicSerializable();
			SerializableClass serClass = ser.SerializableProperty;
			await (s.SaveAsync(ser));
			await (s.FlushAsync());
			s.Close();

			s = OpenSession();
			ser = (BasicSerializable) await (s.LoadAsync(typeof(BasicSerializable), ser.Id));
			Assert.IsNull(ser.Serial, "should have saved as null");

			ser.Serial = ser.SerializableProperty;
			await (s.FlushAsync());
			s.Close();

			s = OpenSession();
			ser = (BasicSerializable) await (s.LoadAsync(typeof(BasicSerializable), ser.Id));
			Assert.IsTrue(ser.Serial is SerializableClass, "should have been a SerializableClass");
			Assert.AreEqual(ser.SerializableProperty, ser.Serial,
			                "SerializablePorperty and Serial should both be 5 and 'serialize me'");

			IDictionary props = new Hashtable();
			props["foo"] = "bar";
			props["bar"] = "foo";
			ser.Serial = props;
			await (s.FlushAsync());

			props["x"] = "y";
			await (s.FlushAsync());
			s.Close();

			s = OpenSession();
			ser = (BasicSerializable) await (s.LoadAsync(typeof(BasicSerializable), ser.Id));

			props = (IDictionary) ser.Serial;
			Assert.AreEqual("bar", props["foo"]);
			Assert.AreEqual("y", props["x"]);
			Assert.AreEqual(serClass, ser.SerializableProperty);

			ser.SerializableProperty._classString = "modify me";
			await (s.FlushAsync());
			s.Close();

			s = OpenSession();
			ser = (BasicSerializable) await (s.LoadAsync(typeof(BasicSerializable), ser.Id));
			Assert.AreEqual("modify me", ser.SerializableProperty._classString);
			Assert.AreEqual("bar", props["foo"]);
			Assert.AreEqual("y", props["x"]);

			await (s.DeleteAsync(ser));
			await (s.FlushAsync());
			s.Close();
		}
	}
}