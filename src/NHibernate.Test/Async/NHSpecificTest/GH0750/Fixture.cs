//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System.Collections.Generic;
using NHibernate.Criterion;
using NHibernate.Transform;
using NUnit.Framework;

namespace NHibernate.Test.NHSpecificTest.GH0750
{
	using System.Threading.Tasks;
	using System.Threading;

	[TestFixture]
	public class FixtureAsync : BugTestCase
	{
		protected override void OnSetUp()
		{
			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				var greenTea = new Product()
				{
					ProductId = 1,
					Name = "Green Tea",
					UnitPrice = 5
				};

				session.Save(greenTea);

				var blackTea = new Product()
				{
					ProductId = 2,
					Name = "Black Tea",
					UnitPrice = 10
				};

				session.Save(blackTea);

				var greenTeaOrder = new Order()
				{
					OrderId = 1,
					OrderDate = System.DateTime.Now
				};

				session.Save(greenTeaOrder);

				greenTeaOrder.OrderLines.Add(new OrderLine() { Order = greenTeaOrder, Product = greenTea, Quantity = 2, UnitPrice = greenTea.UnitPrice ?? 0 });

				session.Save(greenTeaOrder);

				var blackTeaOrder = new Order()
				{
					OrderId = 2,
					OrderDate = System.DateTime.Now
				};

				session.Save(blackTeaOrder);

				blackTeaOrder.OrderLines.Add(new OrderLine() { Order = blackTeaOrder, Product = blackTea, Quantity = 5, UnitPrice = blackTea.UnitPrice ?? 0 });

				session.Save(blackTeaOrder);
				tx.Commit();
			}
		}

		protected override void OnTearDown()
		{
			using (var s = OpenSession())
			using (var tx = s.BeginTransaction())
			{
				s.CreateQuery("delete from OrderLine").ExecuteUpdate();
				s.CreateQuery("delete from System.Object").ExecuteUpdate();
				tx.Commit();
			}
		}

		[Test]
		public void MapQueryResultWithAliasToBeanTransformerAsync()
		{
			Assert.DoesNotThrowAsync(() => GetSaleSummariesAsync());
		}

		public async Task<IList<ProductSummary>> GetSaleSummariesAsync(CancellationToken cancellationToken = default(CancellationToken))
		{
			using (var session = OpenSession())
			using (var tx = session.BeginTransaction())
			{
				var criteria = session
					.CreateCriteria<Order>("O")
					.CreateCriteria("O.OrderLines", "OI", SqlCommand.JoinType.InnerJoin)
					.CreateCriteria("OI.Product", "P", SqlCommand.JoinType.InnerJoin);

				var summaeries = await (criteria
					.SetProjection(Projections.ProjectionList().Add(Projections.Property("P.ProductId"), "ProductId")
					.Add(Projections.Property("P.Name"), "Name")
					.Add(Projections.Sum(Projections.Cast(NHibernateUtil.Int32, Projections.Property("OI.Quantity"))), "TotalQuantity")
					.Add(Projections.Sum("OI.UnitPrice"), "TotalPrice")
					.Add(Projections.GroupProperty("P.ProductId"))
					.Add(Projections.GroupProperty("P.Name")))
					.SetResultTransformer(Transformers.AliasToBean(typeof(ProductSummary)))
					.ListAsync<ProductSummary>(cancellationToken));
				await (tx.CommitAsync(cancellationToken));
				return summaeries;
			}
		}
	}
}
