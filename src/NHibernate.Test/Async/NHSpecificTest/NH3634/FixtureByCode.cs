//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System.Linq;
using NHibernate.Cfg.MappingSchema;
using NHibernate.Criterion;
using NHibernate.Mapping.ByCode;
using NUnit.Framework;
using NHibernate.Linq;

namespace NHibernate.Test.NHSpecificTest.NH3634
{
	using System.Threading.Tasks;
	[TestFixture]
	public class ByCodeFixtureAsync : TestCaseMappingByCode
	{
		protected override HbmMapping GetMappings()
		{
			var mapper = new ModelMapper();
			mapper.AddMapping<PersonMapper>();
			mapper.AddMapping<CachedPersonMapper>();

			return mapper.CompileMappingForAllExplicitlyAddedEntities();
		}

		protected override void OnSetUp()
		{
			using (ISession session = OpenSession())
			using (ITransaction transaction = session.BeginTransaction())
			{
				var bobsConnection = new Connection
					{
						Address = "test.com",
						ConnectionType = "http",
						PortName = "80"
					};
				var e1 = new Person
					{
						Name = "Bob", 
						Connection = bobsConnection
					};
				session.Save(e1);

				var sallysConnection = new Connection
					{
						Address = "test.com",
						ConnectionType = "http",
					};
				var e2 = new Person
					{
						Name = "Sally", 
						Connection = sallysConnection
					};
				session.Save(e2);

				var cachedNullConnection = new Connection
				{
					Address = "test.com",
					ConnectionType = "http",
				};
				var cachedNullConnectionPerson = new CachedPerson
				{
					Name = "CachedNull",
					Connection = cachedNullConnection
				};
				var cachedNotNullConnection = new Connection
				{
					Address = "test.com",
					ConnectionType = "http",
					PortName = "port"
				};
				var cachedNotNullConnectionPerson = new CachedPerson
				{
					Name = "CachedNotNull",
					Connection = cachedNotNullConnection
				};
				session.Save(cachedNullConnectionPerson);
				session.Save(cachedNotNullConnectionPerson);

				session.Flush();
				transaction.Commit();
				session.Evict(typeof(CachedPerson));
			}
		}

		protected override void OnTearDown()
		{
			using (ISession session = OpenSession())
			using (ITransaction transaction = session.BeginTransaction())
			{
				session.Delete("from System.Object");
				session.Flush();
				transaction.Commit();
			}
		}

		[Test]
		public async Task QueryOverComponentWithANullPropertyAsync()
		{
//			Broken at the time NH3634 was reported
//			Generates the following Rpc(exec sp_executesql)
//			SELECT this_.Id as Id0_0_, 
//				   this_.Name as Name0_0_, 
//				   this_.ConnectionType as Connecti3_0_0_, 
//				   this_.Address as Address0_0_, 
//				   this_.PortName as PortName0_0_ 
//			  FROM people this_ 
//			 WHERE this_.ConnectionType = @p0 
//			   and this_.Address = @p1 
//			   and this_.PortName = @p2
//
//			@p0=N'http',@p1=N'test.com',@p2=NULL

			using (ISession session = OpenSession())
			using (session.BeginTransaction())
			{
				var componentToCompare = new Connection
					{
						ConnectionType = "http",
						Address = "test.com", 
						PortName = null
					};
				var sally = await (session.QueryOver<Person>()
								   .Where(p => p.Connection == componentToCompare)
								   .SingleOrDefaultAsync<Person>());

				Assert.That(sally, Is.Not.Null);
				Assert.That(sally.Name, Is.EqualTo("Sally"));
				Assert.That(sally.Connection.PortName, Is.Null);
			}
		}

		[Test]
		public async Task QueryAgainstComponentWithANullPropertyUsingCriteriaAsync()
		{
//			Broken at the time NH3634 was reported
//			Generates the following Rpc(exec sp_executesql)
//			SELECT this_.Id as Id0_0_, 
//				   this_.Name as Name0_0_, 
//				   this_.ConnectionType as Connecti3_0_0_, 
//				   this_.Address as Address0_0_, 
//				   this_.PortName as PortName0_0_ 
//			  FROM people this_ 
//			 WHERE this_.ConnectionType = @p0 
//			   and this_.Address = @p1 
//			   and this_.PortName = @p2
//
//			@p0=N'http',@p1=N'test.com',@p2=NULL

			using (ISession session = OpenSession())
			using (session.BeginTransaction())
			{
				var componentToCompare = new Connection
				{
					ConnectionType = "http",
					Address = "test.com",
					PortName = null
				};
				var sally = await (session.CreateCriteria<Person>()
				                   .Add(Restrictions.Eq("Connection", componentToCompare))
				                   .UniqueResultAsync<Person>());

				Assert.That(sally, Is.Not.Null);
				Assert.That(sally.Name, Is.EqualTo("Sally"));
				Assert.That(sally.Connection.PortName, Is.Null);
			}
		}

		[Test]
		public async Task CachedQueryMissesWithDifferentNotNullComponentAsync()
		{
			var componentToCompare = new Connection
				{
					ConnectionType = "http",
					Address = "test.com",
					PortName = null
				};

			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				var cached = await (session.CreateCriteria<CachedPerson>()
								   .Add(Restrictions.Eq("Connection", componentToCompare))
								   .SetCacheable(true)
								   .UniqueResultAsync<CachedPerson>());

				Assert.That(cached, Is.Not.Null);
				Assert.That(cached.Name, Is.EqualTo("CachedNull"));
				Assert.That(cached.Connection.PortName, Is.Null);

				using (var dbCommand = session.Connection.CreateCommand())
				{
					dbCommand.CommandText = "DELETE FROM cachedpeople";
					tx.Enlist(dbCommand);
					await (dbCommand.ExecuteNonQueryAsync());
				}

				await (tx.CommitAsync());
			}

			componentToCompare.PortName = "port";
			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				//Cache should not return cached entity, because it no longer matches criteria
				var cachedPeople = await (session.CreateCriteria<CachedPerson>()
				                          .Add(Restrictions.Eq("Connection", componentToCompare))
				                          .SetCacheable(true)
				                          .ListAsync<CachedPerson>());

				Assert.That(cachedPeople, Is.Empty);

				await (tx.CommitAsync());
			}
		}

		[Test]
		public async Task CachedQueryMissesWithDifferentNullComponentAsync()
		{
			var componentToCompare = new Connection
				{
					ConnectionType = "http",
					Address = "test.com",
					PortName = "port"
				};

			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				var cached = await (session.CreateCriteria<CachedPerson>()
								   .Add(Restrictions.Eq("Connection", componentToCompare))
								   .SetCacheable(true)
								   .UniqueResultAsync<CachedPerson>());

				Assert.That(cached, Is.Not.Null);
				Assert.That(cached.Name, Is.EqualTo("CachedNotNull"));
				Assert.That(cached.Connection.PortName, Is.Not.Null);

				using (var dbCommand = session.Connection.CreateCommand())
				{
					dbCommand.CommandText = "DELETE FROM cachedpeople";
					tx.Enlist(dbCommand);
					await (dbCommand.ExecuteNonQueryAsync());
				}

				await (tx.CommitAsync());
			}

			componentToCompare.PortName = null;
			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				//Cache should not return cached entity, because it no longer matches criteria
				var cachedPeople = await (session.CreateCriteria<CachedPerson>()
				                          .Add(Restrictions.Eq("Connection", componentToCompare))
				                          .SetCacheable(true)
				                          .ListAsync<CachedPerson>());

				Assert.That(cachedPeople, Is.Empty);

				await (tx.CommitAsync());
			}
		}

		[Test]
		public async Task CachedQueryAgainstComponentWithANullPropertyUsingCriteriaAsync()
		{
			var componentToCompare = new Connection
				{
					ConnectionType = "http",
					Address = "test.com",
					PortName = null
				};

			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				var cached = await (session.CreateCriteria<CachedPerson>()
								   .Add(Restrictions.Eq("Connection", componentToCompare))
								   .SetCacheable(true)
								   .UniqueResultAsync<CachedPerson>());

				Assert.That(cached, Is.Not.Null);
				Assert.That(cached.Name, Is.EqualTo("CachedNull"));
				Assert.That(cached.Connection.PortName, Is.Null);

				using (var dbCommand = session.Connection.CreateCommand())
				{
					dbCommand.CommandText = "DELETE FROM cachedpeople";
					tx.Enlist(dbCommand);
					await (dbCommand.ExecuteNonQueryAsync());
				}

				await (tx.CommitAsync());
			}

			using (ISession session = OpenSession())
			using (ITransaction tx = session.BeginTransaction())
			{
				//Should retreive from cache since we deleted directly from database.
				var cached = await (session.CreateCriteria<CachedPerson>()
								   .Add(Restrictions.Eq("Connection", componentToCompare))
								   .SetCacheable(true)
								   .UniqueResultAsync<CachedPerson>());

				Assert.That(cached, Is.Not.Null);
				Assert.That(cached.Name, Is.EqualTo("CachedNull"));
				Assert.That(cached.Connection.PortName, Is.Null);

				await (tx.CommitAsync());
			}
		}

		[Test]
		public async Task QueryOverComponentIsNullAsync()
		{
			using (ISession session = OpenSession())
			using (session.BeginTransaction())
			{
				var person = await (session.QueryOver<Person>()
									.Where(p => p.Connection == null)
									.SingleOrDefaultAsync<Person>());
				Assert.That(person, Is.Null);
			}
		}

		[Test(Description = "GH-2822")]
		public async Task LinqComponentIsNullAsync()
		{
			using (ISession session = OpenSession())
			{
				var person = await (session.Query<Person>()
									.Where(p => p.Name != null && p.Connection == null && p.Name != null)
									.FirstOrDefaultAsync<Person>());
				Assert.That(person, Is.Null);
			}
		}

		[Test]
		public async Task LinqComponentIsNotNullAsync()
		{
			using (ISession session = OpenSession())
			{
				var person = await (session.Query<Person>()
									.Where(p => p.Name != null && p.Connection != null && p.Name != null)
									.FirstOrDefaultAsync<Person>());
				Assert.That(person, Is.Not.Null);
			}
		}
		
		[Test]
		public async Task HqlComponentIsNullAsync()
		{
			using(new SqlLogSpy())
			using (ISession session = OpenSession())
			{
				var p = await (session.CreateQuery("from Person where Connection is null").UniqueResultAsync<Person>());

				Assert.That(p, Is.Null);
			}
		}

		[Test]
		public async Task HqlComponentIsNotNullAsync()
		{
			using (ISession session = OpenSession())
			{
				var p = await (session.CreateQuery("from Person where Connection is not null").SetMaxResults(1).UniqueResultAsync<Person>());

				Assert.That(p, Is.Not.Null);
			}
		}

		[Test]
		public async Task QueryOverANullComponentPropertyAsync()
		{
//          Works at the time NH3634 was reported 
//			Generates the following SqlBatch:			
//			SELECT this_.Id as Id0_0_, 
//				   this_.Name as Name0_0_, 
//				   this_.ConnectionType as Connecti3_0_0_, 
//				   this_.Address as Address0_0_, 
//				   this_.PortName as PortName0_0_ 
//			  FROM people this_ 
//			 WHERE this_.PortName is null

			using (ISession session = OpenSession())
			using (session.BeginTransaction())
			{
				var sally = await (session.QueryOver<Person>()
				                   .Where(p => p.Connection.PortName == null)
				                   .And(p => p.Connection.Address == "test.com")
				                   .And(p => p.Connection.ConnectionType == "http")
				                   .SingleOrDefaultAsync<Person>());

				Assert.That(sally, Is.Not.Null);
				Assert.That(sally.Name, Is.EqualTo("Sally"));
				Assert.That(sally.Connection.PortName, Is.Null);
			}
		}

		[Test]
		public async Task QueryAgainstANullComponentPropertyUsingCriteriaApiAsync()
		{
			using (ISession session = OpenSession())
			using (session.BeginTransaction())
			{
				var sally = await (session.CreateCriteria<Person>()
				                   .Add(Restrictions.Eq("Connection.PortName", null))
				                   .Add(Restrictions.Eq("Connection.Address", "test.com"))
				                   .Add(Restrictions.Eq("Connection.ConnectionType", "http"))
				                   .UniqueResultAsync<Person>());

				Assert.That(sally, Is.Not.Null);
				Assert.That(sally.Name, Is.EqualTo("Sally"));
				Assert.That(sally.Connection.PortName, Is.Null);
			}
		}
	}
}
