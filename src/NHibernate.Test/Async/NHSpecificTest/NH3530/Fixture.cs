//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System;
using System.Collections.Generic;
using System.Linq;
using NHibernate.Cfg;
using NHibernate.Cfg.MappingSchema;
using NHibernate.Loader;
using NUnit.Framework;
using Environment = NHibernate.Cfg.Environment;

namespace NHibernate.Test.NHSpecificTest.NH3530
{
	using System.Threading.Tasks;
	using System.Threading;
	//NH-3530 (GH-1316) 
	[TestFixture]
	public class DynamicBatchFetchStyleFixtureAsync : TestCaseMappingByCode
	{
		private readonly List<object> _ids = new List<object>();

		protected override void Configure(Configuration configuration)
		{
			base.Configure(configuration);
			configuration.SetProperty(Environment.BatchFetchStyle, BatchFetchStyle.Dynamic.ToString());
		}

		[Test]
		public async Task CanLoadEntityAsync()
		{
			await (PrepareEntitiesAsync(2));

			using (var session = OpenSession())
			{
				var proxy = await (session.LoadAsync<Entity>(_ids[0]));
				var result = await (session.GetAsync<Entity>(_ids[1]));

				Assert.That(result.Name, Is.Not.Null);

				var childrenCount = result.Children.Count;
				//Assert.That(NHibernateUtil.IsInitialized(proxy), Is.True);
				Assert.That(NHibernateUtil.IsInitialized(proxy.Children), Is.True);
				Assert.That(childrenCount, Is.EqualTo(4));
			}
		}

		[KnownBug("GH-2960")]
		[Test]
		public async Task CanLoadComponentEntityAsync()
		{
			await (PrepareComponentEntitiesAsync(2));

			using (var session = OpenSession())
			{
				var proxy = await (session.LoadAsync<EntityComponent>(_ids[0]));
				var result = await (session.GetAsync<EntityComponent>(_ids[1]));

				Assert.That(result.Name, Is.Not.Null);

				var childrenCount = result.Children.Count;
				Assert.That(NHibernateUtil.IsInitialized(proxy.Children), Is.True);
				Assert.That(childrenCount, Is.EqualTo(4));
			}
		}

		[Test]
		public async Task CanLoadComponentIdEntityAsync()
		{
			await (PrepareComponentIdEntitiesAsync(2));

			using (var session = OpenSession())
			{
				var proxy = await (session.LoadAsync<EntityComponentId>(_ids[0]));
				var result = await (session.GetAsync<EntityComponentId>(_ids[1]));

				Assert.That(result.Name, Is.Not.Null);

				var childrenCount = result.Children.Count;
				Assert.That(NHibernateUtil.IsInitialized(proxy.Children), Is.True);
				Assert.That(childrenCount, Is.EqualTo(4));
			}
		}

		[TestCase(1)]
		[TestCase(2)]
		[TestCase(3)]
		[TestCase(4)]
		[TestCase(5)]
		public async Task CanLoadBatchAsync(int loadCount)
		{
			await (PrepareEntitiesAsync(5));

			using (var session = OpenSession())
			{
				foreach (var id in _ids.Take(loadCount))
				{
					await (session.LoadAsync<Entity>(id));
				}

				var result = await (session.GetAsync<Entity>(_ids[0]));
				var result2 = await (session.GetAsync<Entity>(_ids[1]));
				var last = await (session.GetAsync<Entity>(_ids.Last()));

				var count = result.Children.Count;
				Assert.That(result.Name, Is.Not.Null);
				Assert.That(last.Name, Is.Not.Null);
				Assert.That(NHibernateUtil.IsInitialized(result2.Children), Is.True);
			}
		}

		protected override void OnTearDown()
		{
			using (var session = OpenSession())
			using (var transaction = session.BeginTransaction())
			{
				session.CreateQuery("delete from System.Object").ExecuteUpdate();
				transaction.Commit();
			}
		}

		protected override HbmMapping GetMappings()
		{
			return EntityMappings.CreateMapping();
		}

		private async Task PrepareEntitiesAsync(int count, CancellationToken cancellationToken = default(CancellationToken))
		{
			_ids.Clear();
			using (var session = OpenSession())
			using (var transaction = session.BeginTransaction())
			{
				for (int i = 0; i < count; i++)
				{
					var entity = new Entity { Name = "some name" + 1 };
					AddChildren(entity.Children, 4);
					_ids.Add((Guid) await (session.SaveAsync(entity, cancellationToken)));
				}

				await (transaction.CommitAsync(cancellationToken));
			}
		}

		private async Task PrepareComponentEntitiesAsync(int count, CancellationToken cancellationToken = default(CancellationToken))
		{
			_ids.Clear();
			using (var session = OpenSession())
			using (var transaction = session.BeginTransaction())
			{
				for (int i = 0; i < count; i++)
				{
					var entity = new EntityComponent { Id1 = i, Id2 = i + 1, Name = "some name" + 1 };
					AddChildren(entity.Children, 4);

					_ids.Add(await (session.SaveAsync(entity, cancellationToken)));
				}

				await (transaction.CommitAsync(cancellationToken));
			}
		}

		private async Task PrepareComponentIdEntitiesAsync(int count, CancellationToken cancellationToken = default(CancellationToken))
		{
			_ids.Clear();
			using (var session = OpenSession())
			using (var transaction = session.BeginTransaction())
			{
				for (int i = 0; i < count; i++)
				{
					var entity = new EntityComponentId { Id = new ComponentId { Id1 = i, Id2 = i + 1 }, Name = "some name" + 1 };
					AddChildren(entity.Children, 4);
					_ids.Add(await (session.SaveAsync(entity, cancellationToken)));
				}

				await (transaction.CommitAsync(cancellationToken));
			}
		}

		private static void AddChildren<T>(IList<T> list, int count) where T : new()
		{
			for (int i = 0; i < count; i++)
			{
				list.Add(new T());
			}
		}
	}
}
