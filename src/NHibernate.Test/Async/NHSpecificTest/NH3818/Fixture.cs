//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System;
using System.Linq;
using NUnit.Framework;
using NHibernate.Linq;

namespace NHibernate.Test.NHSpecificTest.NH3818
{
    using System.Threading.Tasks;
    [TestFixture]
    public class FixtureAsync : BugTestCase
    {
        [Test]
        public async Task SelectConditionalValuesTestAsync()
        {
            var now = RoundForDialect(DateTime.Now);
            using (var spy = new SqlLogSpy())
            using (var session = OpenSession())
            using (session.BeginTransaction())
            {
                var days = 33;

                var cat = new MyLovelyCat
                {
                    GUID = Guid.NewGuid(),
                    Birthdate = now.AddDays(-days),
                    Color = "Black",
                    Name = "Kitty",
                    Price = 0
                };
                await (session.SaveAsync(cat));
                
                await (session.FlushAsync());

                var catInfo =
                    await (session.Query<MyLovelyCat>()
                        .Select(o => new
                        {
                            o.Color,
                            AliveDays = (now - o.Birthdate).TotalDays,
                            o.Name,
                            o.Price,
                        })
                        .SingleAsync());

                //Console.WriteLine(spy.ToString());
                // We need a tolerance: we are diffing dates as a timespan instead of counting days boundaries,
                // yielding a float. TimeSpan.Days yould always truncate a resulting partial day, so do not use it.
                Assert.That(catInfo.AliveDays, Is.EqualTo(days).Within(0.1));

                var catInfo2 =
                    await (session.Query<MyLovelyCat>()
                        .Select(o => new
                        {
                            o.Color,
                            AliveDays = o.Price > 0 ? (now - o.Birthdate).TotalDays : 0,
                            o.Name,
                            o.Price,
                        })
                        .SingleAsync());

                //Console.WriteLine(spy.ToString());
                Assert.That(catInfo2.AliveDays, Is.EqualTo(0));

            }
        }

    }
}
