//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System;
using System.Data;
using System.Data.Common;
using NHibernate.Driver;
using NHibernate.SqlCommand;
using NHibernate.SqlTypes;
using NUnit.Framework;

namespace NHibernate.Test.DriverTest
{
	using System.Threading.Tasks;
	using System.Threading;
	[TestFixture]
	public class FirebirdClientDriverFixtureAsync
	{
		private string _connectionString;
		private FirebirdClientDriver _driver;

		[Test]
		public async Task ConnectionPooling_OpenThenCloseThenOpenAnotherOne_OnlyOneConnectionIsPooledAsync()
		{
			MakeDriver();

			_driver.ClearPool(_connectionString);

			var allreadyEstablished = await (GetEstablishedConnectionsAsync());

			var connection1 = MakeConnection();
			var connection2 = MakeConnection();

			//open first connection
			await (connection1.OpenAsync());
			await (VerifyCountOfEstablishedConnectionsIsAsync(allreadyEstablished + 1, "After first open"));

			//return it to the pool
			connection1.Close();
			await (VerifyCountOfEstablishedConnectionsIsAsync(allreadyEstablished + 1, "After first close"));

			//open the second connection
			await (connection2.OpenAsync());
			await (VerifyCountOfEstablishedConnectionsIsAsync(allreadyEstablished + 1, "After second open"));

			//return it to the pool
			connection2.Close();
			await (VerifyCountOfEstablishedConnectionsIsAsync(allreadyEstablished + 1, "After second close"));
		}

		[Test]
		public async Task ConnectionPooling_OpenThenCloseTwoAtTheSameTime_TowConnectionsArePooledAsync()
		{
			MakeDriver();

			_driver.ClearPool(_connectionString);

			var allreadyEstablished = await (GetEstablishedConnectionsAsync());

			var connection1 = MakeConnection();
			var connection2 = MakeConnection();

			//open first connection
			await (connection1.OpenAsync());
			await (VerifyCountOfEstablishedConnectionsIsAsync(allreadyEstablished + 1, "After first open"));

			//open second one
			await (connection2.OpenAsync());
			await (VerifyCountOfEstablishedConnectionsIsAsync(allreadyEstablished + 2, "After second open"));

			//return connection1 to the pool
			connection1.Close();
			await (VerifyCountOfEstablishedConnectionsIsAsync(allreadyEstablished + 2, "After first close"));

			//return connection2 to the pool
			connection2.Close();
			await (VerifyCountOfEstablishedConnectionsIsAsync(allreadyEstablished + 2, "After second close"));
		}

		private void MakeDriver()
		{
			var cfg = TestConfigurationHelper.GetDefaultConfiguration();
			var dlct = cfg.GetProperty("dialect");
			if (!dlct.Contains("Firebird"))
				Assert.Ignore("Applies only to Firebird");

			_driver = new FirebirdClientDriver();
			_connectionString = cfg.GetProperty("connection.connection_string");
		}

		private DbConnection MakeConnection()
		{
			var result = _driver.CreateConnection();
			result.ConnectionString = _connectionString;
			return result;
		}

		private async Task VerifyCountOfEstablishedConnectionsIsAsync(int expectedCount, string step, CancellationToken cancellationToken = default(CancellationToken))
		{
			var physicalConnections = await (GetEstablishedConnectionsAsync(cancellationToken));
			Assert.That(physicalConnections, Is.EqualTo(expectedCount), step);
		}

		private async Task<int> GetEstablishedConnectionsAsync(CancellationToken cancellationToken = default(CancellationToken))
		{
			using (var conn = _driver.CreateConnection())
			{
				conn.ConnectionString = _connectionString;
				await (conn.OpenAsync(cancellationToken));
				using (var cmd = conn.CreateCommand())
				{
					cmd.CommandText = "select count(*) from mon$attachments where mon$attachment_id <> current_connection";
					return Convert.ToInt32(await (cmd.ExecuteScalarAsync(cancellationToken)));
				}
			}
		}

		private DbCommand BuildSelectCaseCommand(SqlType paramType)
		{
			var sqlString = new SqlStringBuilder()
					.Add("select (case when col = ")
					.AddParameter()
					.Add(" then ")
					.AddParameter()
					.Add(" else ")
					.AddParameter()
					.Add(" end) from table")
					.ToSqlString();

			return _driver.GenerateCommand(CommandType.Text, sqlString, new[] { paramType, paramType, paramType });
		}

		private DbCommand BuildSelectConcatCommand(SqlType paramType)
		{
			var sqlString = new SqlStringBuilder()
					.Add("select col || ")
					.AddParameter()
					.Add(" || ")
					.Add("col ")
					.Add("from table")
					.ToSqlString();

			return _driver.GenerateCommand(CommandType.Text, sqlString, new[] { paramType });
		}

		private DbCommand BuildSelectAddCommand(SqlType paramType)
		{
			var sqlString = new SqlStringBuilder()
					.Add("select col + ")
					.AddParameter()
					.Add(" from table")
					.ToSqlString();

			return _driver.GenerateCommand(CommandType.Text, sqlString, new[] { paramType });
		}

		private DbCommand BuildInsertWithParamsInSelectCommand(SqlType paramType)
		{
			var sqlString = new SqlStringBuilder()
				.Add("insert into table1 (col1, col2) ")
				.Add("select col1, ")
				.AddParameter()
				.Add(" from table2")
				.ToSqlString();

			return _driver.GenerateCommand(CommandType.Text, sqlString, new[] { paramType });
		}
		private DbCommand BuildInsertWithParamsInSelectCommandWithSelectInColumnName(SqlType paramType)
		{
			var sqlString = new SqlStringBuilder()
				.Add("insert into table1 (col1_select_aaa) ")
				.Add("values(")
				.AddParameter()
				.Add(") from table2")
				.ToSqlString();

			return _driver.GenerateCommand(CommandType.Text, sqlString, new[] { paramType });
		}

        private DbCommand BuildInsertWithParamsInSelectCommandWithWhereInColumnName(SqlType paramType)
		{
			var sqlString = new SqlStringBuilder()
				.Add("insert into table1 (col1_where_aaa) ")
				.Add("values(")
				.AddParameter()
				.Add(") from table2")
				.ToSqlString();

			return _driver.GenerateCommand(CommandType.Text, sqlString, new[] { paramType });
		}
	}
}
