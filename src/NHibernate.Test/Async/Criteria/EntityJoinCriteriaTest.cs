//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System;
using NHibernate.Cfg.MappingSchema;
using NHibernate.Criterion;
using NHibernate.Mapping.ByCode;
using NHibernate.SqlCommand;
using NUnit.Framework;

namespace NHibernate.Test.Criteria
{
	using System.Threading.Tasks;
	/// <summary>
	/// Tests for explicit entity joins (not associated entities)
	/// </summary>
	[TestFixture]
	public class EntityJoinCriteriaTestAsync : TestCaseMappingByCode
	{
		private const string customEntityName = "CustomEntityName";
		private EntityWithCompositeId _entityWithCompositeId;
		private EntityWithNoAssociation _noAssociation;
		private EntityCustomEntityName _entityWithCustomEntityName;

		//check JoinEntityAlias - JoinAlias analog for entity join
		[Test]
		public async Task CanJoinNotAssociatedEntityAsync()
		{
			using (var sqlLog = new SqlLogSpy())
			using (var session = OpenSession())
			{
				EntityComplex entityComplex = null;
				EntityWithNoAssociation root = null;
				root = await (session.QueryOver<EntityWithNoAssociation>(() => root)
						.JoinEntityAlias(() => entityComplex, Restrictions.Where(() => root.Complex1Id == entityComplex.Id), JoinType.InnerJoin).Take(1)
						.SingleOrDefaultAsync());
				entityComplex = await (session.LoadAsync<EntityComplex>(root.Complex1Id));

				Assert.That(NHibernateUtil.IsInitialized(entityComplex), Is.True);
				Assert.That(sqlLog.Appender.GetEvents().Length, Is.EqualTo(1), "Only one SQL select is expected");
			}
		}
		
		//check JoinEntityAlias - JoinAlias analog for entity join
		[Test]
		public async Task CanJoinNotAssociatedEntity_ExpressionAsync()
		{
			using (var sqlLog = new SqlLogSpy())
			using (var session = OpenSession())
			{
				EntityComplex entityComplex = null;
				EntityWithNoAssociation root = null;
				root = await (session.QueryOver(() => root)
						.JoinEntityAlias(() => entityComplex, () => root.Complex1Id == entityComplex.Id).Take(1)
						.SingleOrDefaultAsync());
				entityComplex = await (session.LoadAsync<EntityComplex>(root.Complex1Id));

				Assert.That(NHibernateUtil.IsInitialized(entityComplex), Is.True);
				Assert.That(sqlLog.Appender.GetEvents().Length, Is.EqualTo(1), "Only one SQL select is expected");
			}
		}
		
		//check JoinEntityQueryOver - JoinQueryOver analog for entity join
		[Test]
		public async Task CanJoinEntityQueryOverAsync()
		{
			using (var sqlLog = new SqlLogSpy())
			using (var session = OpenSession())
			{
				EntityComplex ejQueryOver = null;
				EntityWithNoAssociation root = null;
				root = await (session.QueryOver<EntityWithNoAssociation>(() => root)
							.JoinEntityQueryOver(() => ejQueryOver, Restrictions.Where(() => root.Complex1Id == ejQueryOver.Id), JoinType.InnerJoin)
							.Take(1)
							.SingleOrDefaultAsync());
				ejQueryOver = await (session.LoadAsync<EntityComplex>(root.Complex1Id));

				Assert.That(NHibernateUtil.IsInitialized(ejQueryOver), Is.True);
				Assert.That(sqlLog.Appender.GetEvents().Length, Is.EqualTo(1), "Only one SQL select is expected");
			}
		}
		
		//can join not associated entity and join associated entities for it via JoinQueryOver
		[Test]
		public async Task CanQueryOverForAssociationInNotAssociatedEntityAsync()
		{
			using (var sqlLog = new SqlLogSpy())
			using (var session = OpenSession())
			{
				EntityComplex ejComplex = null;
				EntityWithNoAssociation root = null;
				root = await (session.QueryOver<EntityWithNoAssociation>(() => root)
							.JoinEntityQueryOver(() => ejComplex, Restrictions.Where(() => root.Complex1Id == ejComplex.Id), JoinType.InnerJoin)
							.JoinQueryOver(ej => ej.Child1)
							.Take(1)
							.SingleOrDefaultAsync());

				ejComplex = await (session.LoadAsync<EntityComplex>(root.Complex1Id));

				Assert.That(NHibernateUtil.IsInitialized(ejComplex), Is.True);
				Assert.That(NHibernateUtil.IsInitialized(ejComplex.Child1), Is.True);
				Assert.That(NHibernateUtil.IsInitialized(ejComplex.Child2), Is.False);
				Assert.That(sqlLog.Appender.GetEvents().Length, Is.EqualTo(1), "Only one SQL select is expected");
			}
		}

		[Test]
		public async Task SimpleProjectionForEntityJoinAsync()
		{
			using (var sqlLog = new SqlLogSpy())
			using (var session = OpenSession())
			{
				EntityComplex ejComplex = null;
				EntityWithNoAssociation root = null;
				var name = await (session.QueryOver<EntityWithNoAssociation>(() => root)
							.JoinEntityQueryOver(() => ejComplex, Restrictions.Where(() => root.Complex1Id == ejComplex.Id), JoinType.InnerJoin)
							.Select((e) => ejComplex.Name)
							.Take(1)
							.SingleOrDefaultAsync<string>());
				
				Assert.That(name, Is.Not.Empty);
				Assert.That(sqlLog.Appender.GetEvents().Length, Is.EqualTo(1), "Only one SQL select is expected");
			}
		}

		[Test]
		public async Task EntityProjectionForEntityJoinAsync()
		{
			using (var sqlLog = new SqlLogSpy())
			using (var session = OpenSession())
			{
				EntitySimpleChild ejChild1 = null;

				EntityComplex root = null;
				EntityComplex st = null;
				var r = await (session
						.QueryOver<EntityComplex>(() => root)
						.JoinAlias(c => c.SameTypeChild, () => st)
						.JoinEntityAlias(() => ejChild1, Restrictions.Where(() => ejChild1.Id == root.Child1.Id), JoinType.InnerJoin)
						.Select(
							Projections.RootEntity(),
							Projections.Entity(() => st),
							Projections.Entity(() => ejChild1)
						)
						.SingleOrDefaultAsync<object[]>());
				var rootObj = (EntityComplex) r[0];
				var mappedObj =  (EntityComplex) r[1];
				var entityJoinObj =  (EntitySimpleChild) r[2];

				Assert.That(rootObj, Is.Not.Null);
				Assert.That(mappedObj, Is.Not.Null);
				Assert.That(entityJoinObj, Is.Not.Null);
				Assert.That(NHibernateUtil.IsInitialized(rootObj), Is.True);
				Assert.That(NHibernateUtil.IsInitialized(mappedObj), Is.True);
				Assert.That(NHibernateUtil.IsInitialized(entityJoinObj), Is.True);
			}
		}

		//just check that it can be executed without error
		[Test]
		public async Task MixOfJoinsForAssociatedAndNotAssociatedEntitiesAsync()
		{
			using (var sqlLog = new SqlLogSpy())
			using (var session = OpenSession())
			{

				EntityComplex root = null;
				EntityComplex ejLevel1 = null;
				EntitySimpleChild customChildForEjLevel1 = null;
				EntityComplex entityComplexForEjLevel1 = null;
				EntitySimpleChild ejLevel2OnEntityComplexForEjLevel1 = null;
				var obj = await (session
						.QueryOver<EntityComplex>(() => root)
						.JoinEntityAlias(() => ejLevel1, Restrictions.Where(() => ejLevel1.Id == root.SameTypeChild.Id && root.Id != null), JoinType.LeftOuterJoin)
						.JoinAlias(() => ejLevel1.Child1, () => customChildForEjLevel1, JoinType.InnerJoin)
						.JoinAlias(() => ejLevel1.SameTypeChild, () => entityComplexForEjLevel1, JoinType.LeftOuterJoin)
						.JoinEntityAlias(() => ejLevel2OnEntityComplexForEjLevel1, Restrictions.Where(() => entityComplexForEjLevel1.Id == ejLevel2OnEntityComplexForEjLevel1.Id), JoinType.InnerJoin)
						.Where(() => customChildForEjLevel1.Id != null && ejLevel2OnEntityComplexForEjLevel1.Id != null)
						.Take(1)
						.SingleOrDefaultAsync<object>());
			}
		}

		[Test]
		public async Task EntityJoinForCompositeKeyAsync()
		{
			using (var sqlLog = new SqlLogSpy())
			using (var session = OpenSession())
			{
				EntityWithCompositeId ejComposite = null;
				EntityWithNoAssociation root = null;
				root = await (session
								.QueryOver<EntityWithNoAssociation>(() => root)
								.JoinEntityAlias(() => ejComposite, Restrictions.Where(() => root.Composite1Key1 == ejComposite.Key.Id1 && root.Composite1Key2 == ejComposite.Key.Id2), JoinType.InnerJoin)
								.Take(1).SingleOrDefaultAsync());
				var composite = await (session.LoadAsync<EntityWithCompositeId>(_entityWithCompositeId.Key));

				Assert.That(NHibernateUtil.IsInitialized(composite), Is.True, "Object must be initialized");
				Assert.That(composite, Is.EqualTo(_entityWithCompositeId).Using((EntityWithCompositeId x, EntityWithCompositeId y) => (Equals(x.Key, y.Key) && Equals(x.Name, y.Name)) ? 0 : 1));
				Assert.That(sqlLog.Appender.GetEvents().Length, Is.EqualTo(1), "Only one SQL select is expected");
			}
		}

		[Test]
		public async Task NullLeftEntityJoinAsync()
		{
			using (var sqlLog = new SqlLogSpy())
			using (var session = OpenSession())
			{
				EntityComplex ejLeftNull = null;
				EntityWithNoAssociation root = null;
				root = await (session.QueryOver<EntityWithNoAssociation>(() => root)
							//add some non existent
							.JoinEntityAlias(() => ejLeftNull, Restrictions.Where(() => ejLeftNull.Id == null), JoinType.LeftOuterJoin)
							.Take(1)
							.SingleOrDefaultAsync());

				Assert.That(root, Is.Not.Null, "root should not be null (looks like left join didn't work)");
				Assert.That(NHibernateUtil.IsInitialized(root), Is.True);
				Assert.That(sqlLog.Appender.GetEvents().Length, Is.EqualTo(1), "Only one SQL select is expected");
			}
		}	
		
		[Test]
		public async Task NullLeftEntityJoinWithEntityProjectionAsync()
		{
			using (var sqlLog = new SqlLogSpy())
			using (var session = OpenSession())
			{
				EntityComplex ejLeftNull = null;
				EntityWithNoAssociation root = null;
				var objs = await (session.QueryOver<EntityWithNoAssociation>(() => root)
							//add some non existent
							.JoinEntityAlias(() => ejLeftNull, Restrictions.Where(() => ejLeftNull.Id == null), JoinType.LeftOuterJoin)
							.Select((e) => root.AsEntity(), e => ejLeftNull.AsEntity())
							.Take(1)
							.SingleOrDefaultAsync<object[]>());
				root = (EntityWithNoAssociation) objs[0];
				ejLeftNull = (EntityComplex) objs[1];

				Assert.That(root, Is.Not.Null, "root should not be null (looks like left join didn't work)");
				Assert.That(NHibernateUtil.IsInitialized(root), Is.True);
				Assert.That(ejLeftNull, Is.Null, "Entity join should be null");
				Assert.That(sqlLog.Appender.GetEvents().Length, Is.EqualTo(1), "Only one SQL select is expected");
			}
		}

		[Test]
		public async Task EntityJoinForCustomEntityNameAsync()
		{
			
			using (var sqlLog = new SqlLogSpy())
			using (var session = OpenSession())
			{
				EntityCustomEntityName ejCustomEntity= null;
				EntityWithNoAssociation root = null;
				root = await (session.QueryOver<EntityWithNoAssociation>(() => root)
							.JoinEntityAlias(() => ejCustomEntity, Restrictions.Where(() => ejCustomEntity.Id == root.CustomEntityNameId), JoinType.InnerJoin, customEntityName)
							.Take(1)
							.SingleOrDefaultAsync());

				ejCustomEntity = await (session.LoadAsync<EntityCustomEntityName>(root.CustomEntityNameId));

				Assert.That(NHibernateUtil.IsInitialized(ejCustomEntity), Is.True);
				Assert.That(sqlLog.Appender.GetEvents().Length, Is.EqualTo(1), "Only one SQL select is expected");
			}
		}

		[Test]
		public async Task EntityJoinFoSubquery_JoinEntityAliasAsync()
		{
			using (var sqlLog = new SqlLogSpy())
			using (var session = OpenSession())
			{
				EntityComplex ej = null;
				EntityWithNoAssociation root = null;

				EntityComplex ejSub = null;
				EntityWithNoAssociation rootSub = null;

				var subquery = QueryOver.Of<EntityWithNoAssociation>(() => rootSub)
										.JoinEntityAlias(() => ejSub, () => rootSub.Complex1Id == ejSub.Id)
										.Where(r => ejSub.Name == ej.Name)
										.Select(x => ejSub.Id);

				root = await (session.QueryOver(() => root)
							.JoinEntityAlias(() => ej, Restrictions.Where(() => root.Complex1Id == ej.Id))
							.WithSubquery.WhereExists(subquery)
							.SingleOrDefaultAsync());
				ej = await (session.LoadAsync<EntityComplex>(root.Complex1Id));

				Assert.That(NHibernateUtil.IsInitialized(ej), Is.True);
				Assert.That(sqlLog.Appender.GetEvents().Length, Is.EqualTo(1), "Only one SQL select is expected");
			}
		}
		
		[Test]
		public async Task EntityJoinFoSubquery_JoinQueryOverAsync()
		{
			using (var sqlLog = new SqlLogSpy())
			using (var session = OpenSession())
			{
				EntityComplex ej = null;
				EntityWithNoAssociation root = null;

				EntityComplex ejSub = null;
				EntityWithNoAssociation rootSub = null;

				var subquery = QueryOver.Of<EntityWithNoAssociation>(() => rootSub)
										.JoinEntityQueryOver(() => ejSub, () => rootSub.Complex1Id == ejSub.Id)
										.Where(x => x.Name == ej.Name)
										.Select(x => ejSub.Id);

				root = await (session.QueryOver(() => root)
							.JoinEntityAlias(() => ej, Restrictions.Where(() => root.Complex1Id == ej.Id))
							.WithSubquery.WhereExists(subquery)
							.SingleOrDefaultAsync());
				ej = await (session.LoadAsync<EntityComplex>(root.Complex1Id));

				Assert.That(NHibernateUtil.IsInitialized(ej), Is.True);
				Assert.That(sqlLog.Appender.GetEvents().Length, Is.EqualTo(1), "Only one SQL select is expected");
			}
		}
		#region Test Setup

		protected override HbmMapping GetMappings()
		{
			var mapper = new ModelMapper();
			mapper.Class<EntityComplex>(
				rc =>
				{
					rc.Id(x => x.Id, m => m.Generator(Generators.GuidComb));

					rc.Version(ep => ep.Version, vm => { });

					rc.Property(x => x.Name);

					rc.Property(ep => ep.LazyProp, m => m.Lazy(true));

					rc.ManyToOne(ep => ep.Child1, m => m.Column("Child1Id"));
					rc.ManyToOne(ep => ep.Child2, m => m.Column("Child2Id"));
					rc.ManyToOne(ep => ep.SameTypeChild, m => m.Column("SameTypeChildId"));

					rc.Bag(
						ep => ep.ChildrenList,
						m =>
						{
							m.Cascade(Mapping.ByCode.Cascade.All);
							m.Inverse(true);
						},
						a => a.OneToMany());

				});

			mapper.Class<EntitySimpleChild>(
				rc =>
				{
					rc.Id(x => x.Id, m => m.Generator(Generators.GuidComb));
					rc.Property(x => x.Name);
				});

			mapper.Class<EntityWithCompositeId>(
				rc =>
				{
					rc.ComponentAsId(
						e => e.Key,
						ekm =>
						{
							ekm.Property(ek => ek.Id1);
							ekm.Property(ek => ek.Id2);
						});

					rc.Property(e => e.Name);
				});
			
			mapper.Class<EntityWithCompositeId>(
				rc =>
				{
					rc.ComponentAsId(
						e => e.Key,
						ekm =>
						{
							ekm.Property(ek => ek.Id1);
							ekm.Property(ek => ek.Id2);
						});

					rc.Property(e => e.Name);
				});

			mapper.Class<EntityWithNoAssociation>(
				rc =>
				{
					rc.Id(e => e.Id, m => m.Generator(Generators.GuidComb));

					rc.Property(e => e.Complex1Id);
					rc.Property(e => e.Complex2Id);
					rc.Property(e => e.Simple1Id);
					rc.Property(e => e.Simple2Id);
					rc.Property(e => e.Composite1Key1);
					rc.Property(e => e.Composite1Key2);
					rc.Property(e => e.CustomEntityNameId);
					
				});

			mapper.Class<EntityCustomEntityName>(
				rc =>
				{
					rc.EntityName(customEntityName);

					rc.Id(e => e.Id, m => m.Generator(Generators.GuidComb));
					rc.Property(e => e.Name);
				});

			return mapper.CompileMappingForAllExplicitlyAddedEntities();
		}

		protected override void OnTearDown()
		{
			using (ISession session = OpenSession())
			using (ITransaction transaction = session.BeginTransaction())
			{
				session.Delete("from System.Object");

				session.Flush();
				transaction.Commit();
			}
		}

		protected override void OnSetUp()
		{
			using (var session = OpenSession())
			using (var transaction = session.BeginTransaction())
			{
				var child1 = new EntitySimpleChild
				{
					Name = "Child1"
				};
				var child2 = new EntitySimpleChild
				{
					Name = "Child1"
				};

				var parent = new EntityComplex
				{
					Name = "ComplexEnityParent",
					Child1 = child1,
					Child2 = child2,
					LazyProp = "SomeBigValue",
					SameTypeChild = new EntityComplex()
					{
						Name = "ComplexEntityChild"
					}
				};

				_entityWithCompositeId = new EntityWithCompositeId
				{
					Key = new CompositeKey
					{
						Id1 = 1,
						Id2 = 2
					},
					Name = "Composite"
				};

				session.Save(child1);
				session.Save(child2);
				session.Save(parent.SameTypeChild);
				session.Save(parent);
				session.Save(_entityWithCompositeId);

				_entityWithCustomEntityName = new EntityCustomEntityName()
				{
					Name = "EntityCustomEntityName"
				};

				session.Save(customEntityName, _entityWithCustomEntityName);

				_noAssociation = new EntityWithNoAssociation()
				{
					Complex1Id = parent.Id,
					Complex2Id = parent.SameTypeChild.Id,
					Composite1Key1 = _entityWithCompositeId.Key.Id1,
					Composite1Key2 = _entityWithCompositeId.Key.Id2,
					Simple1Id = child1.Id,
					Simple2Id = child2.Id,
					CustomEntityNameId = _entityWithCustomEntityName.Id
				};

				session.Save(_noAssociation);

				session.Flush();
				transaction.Commit();
			}
		}

		#endregion Test Setup
	}
}
