//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System;
using System.Collections;
using System.Threading;
using NHibernate.Stat;
using NUnit.Framework;
using NHibernate.Transform;

namespace NHibernate.Test.SecondLevelCacheTests
{
	using System.Threading.Tasks;
	[TestFixture]
	public class ScalarQueryFixtureAsync : TestCase
	{
		protected override string MappingsAssembly
		{
			get { return "NHibernate.Test"; }
		}

		protected override string[] Mappings
		{
			get { return new[] { "SecondLevelCacheTest.Item.hbm.xml" }; }
		}

		protected override void Configure(Cfg.Configuration configuration)
		{
			configuration.SetProperty(Cfg.Environment.GenerateStatistics, "true");
		}

		public async Task FillDbAsync(int startId, CancellationToken cancellationToken = default(CancellationToken))
		{
			using (ISession s = OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				for (int i = startId; i < startId + 10; i++)
				{
					await (s.SaveAsync(new AnotherItem { Id = i, Name = (i / 2).ToString() }, cancellationToken));
				}
				await (tx.CommitAsync(cancellationToken));
			}
		}

		public async Task CleanUpAsync(CancellationToken cancellationToken = default(CancellationToken))
		{
			using (ISession s = OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				await (s.DeleteAsync("from AnotherItem", cancellationToken));
				await (tx.CommitAsync(cancellationToken));
			}
		}

		[Test]
		public async Task ShouldHitCacheUsingNamedQueryWithProjectionAsync()
		{
			await (FillDbAsync(1));
			Sfi.Statistics.Clear();

			using (ISession s = OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				await (s.GetNamedQuery("Stat").ListAsync());
				await (tx.CommitAsync());
			}

			Assert.That(Sfi.Statistics.QueryExecutionCount, Is.EqualTo(1));
			Assert.That(Sfi.Statistics.QueryCachePutCount, Is.EqualTo(1));
			Assert.That(Sfi.Statistics.QueryCacheHitCount, Is.EqualTo(0));

			Sfi.Statistics.Clear();

			using (ISession s = OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				await (s.GetNamedQuery("Stat").ListAsync());
				await (tx.CommitAsync());
			}

			Assert.That(Sfi.Statistics.QueryExecutionCount, Is.EqualTo(0));
			Assert.That(Sfi.Statistics.QueryCacheHitCount, Is.EqualTo(1));

			Sfi.Statistics.LogSummary();
			await (CleanUpAsync());
		}

		[Test]
		public async Task ShouldHitCacheUsingQueryWithProjectionAsync()
		{
			await (FillDbAsync(1));
			Sfi.Statistics.Clear();

			int resultCount;
			using (ISession s = OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				resultCount =
					(await (s.CreateQuery("select ai.Name, count(*) from AnotherItem ai group by ai.Name").SetCacheable(true).SetCacheRegion(
						"Statistics").ListAsync())).Count;
				await (tx.CommitAsync());
			}

			Assert.That(Sfi.Statistics.QueryExecutionCount, Is.EqualTo(1));
			Assert.That(Sfi.Statistics.QueryCachePutCount, Is.EqualTo(1));
			Assert.That(Sfi.Statistics.QueryCacheHitCount, Is.EqualTo(0));

			Sfi.Statistics.Clear();

			int secondResultCount;
			using (ISession s = OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				secondResultCount = (await (s.CreateQuery("select ai.Name, count(*) from AnotherItem ai group by ai.Name")
					.SetCacheable(true).SetCacheRegion("Statistics").ListAsync())).Count;
				await (tx.CommitAsync());
			}

			Assert.That(Sfi.Statistics.QueryExecutionCount, Is.EqualTo(0));
			Assert.That(Sfi.Statistics.QueryCacheHitCount, Is.EqualTo(1));
			Assert.That(secondResultCount, Is.EqualTo(resultCount));

			Sfi.Statistics.LogSummary();
			await (CleanUpAsync());
		}

		[Test]
		public async Task QueryCacheInvalidationAsync()
		{
			await (Sfi.EvictQueriesAsync());
			Sfi.Statistics.Clear();

			const string queryString = "from Item i where i.Name='widget'";

			object savedId = await (CreateItemAsync(queryString));

			QueryStatistics qs = Sfi.Statistics.GetQueryStatistics(queryString);
			EntityStatistics es = Sfi.Statistics.GetEntityStatistics(typeof(Item).FullName);

			await (Task.Delay(200));

			IList result;
			using (ISession s = OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				result = await (s.CreateQuery(queryString).SetCacheable(true).ListAsync());
				Assert.That(result.Count, Is.EqualTo(1));
				await (tx.CommitAsync());
			}

			Assert.That(qs.CacheHitCount, Is.EqualTo(0));

			using (ISession s = OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				result = await (s.CreateQuery(queryString).SetCacheable(true).ListAsync());
				Assert.That(result.Count, Is.EqualTo(1));
				await (tx.CommitAsync());
			}

			Assert.That(qs.CacheHitCount, Is.EqualTo(1));
			Assert.That(es.FetchCount, Is.EqualTo(0));

			using (ISession s = OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				result = await (s.CreateQuery(queryString).SetCacheable(true).ListAsync());
				Assert.That(result.Count, Is.EqualTo(1));
				Assert.That(NHibernateUtil.IsInitialized(result[0]));
				var i = (Item)result[0];
				i.Name = "Widget";
				await (tx.CommitAsync());
			}

			Assert.That(qs.CacheHitCount, Is.EqualTo(2));
			Assert.That(qs.CacheMissCount, Is.EqualTo(2));
			Assert.That(es.FetchCount, Is.EqualTo(0));

			await (Task.Delay(200));

			using (ISession s = OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				await (s.CreateQuery(queryString).SetCacheable(true).ListAsync());

				var i = await (s.GetAsync<Item>(savedId));
				Assert.That(i.Name, Is.EqualTo("Widget"));

				await (s.DeleteAsync(i));
				await (tx.CommitAsync());
			}

			Assert.That(qs.CacheHitCount, Is.EqualTo(2));
			Assert.That(qs.CacheMissCount, Is.EqualTo(3));
			Assert.That(qs.CachePutCount, Is.EqualTo(3));
			Assert.That(qs.ExecutionCount, Is.EqualTo(3));
			Assert.That(es.FetchCount, Is.EqualTo(0)); //check that it was being cached
		}

		private async Task<object> CreateItemAsync(string queryString, CancellationToken cancellationToken = default(CancellationToken))
		{
			object savedId;
			using (ISession s = OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				await (s.CreateQuery(queryString).SetCacheable(true).ListAsync(cancellationToken));
				var i = new Item { Name = "widget" };
				savedId = await (s.SaveAsync(i, cancellationToken));
				await (tx.CommitAsync(cancellationToken));
			}
			return savedId;
		}

		[Test]
		public async Task SimpleProjectionsAsync()
		{
			var transformer = new CustomTransformer();
			await (Sfi.EvictQueriesAsync());
			Sfi.Statistics.Clear();

			const string queryString = "select i.Name, i.Description from AnotherItem i where i.Name='widget'";

			object savedId;
			using (ISession s = OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				await (s.CreateQuery(queryString).SetCacheable(true).ListAsync());
				var i = new AnotherItem { Name = "widget" };
				savedId = await (s.SaveAsync(i));
				await (tx.CommitAsync());
			}

			QueryStatistics qs = Sfi.Statistics.GetQueryStatistics(queryString);
			EntityStatistics es = Sfi.Statistics.GetEntityStatistics(typeof(AnotherItem).FullName);

			await (Task.Delay(200));

			IList result;
			using (ISession s = OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				await (s.CreateQuery(queryString).SetCacheable(true).ListAsync());
				await (tx.CommitAsync());
			}

			Assert.That(qs.CacheHitCount, Is.EqualTo(0));

			using (ISession s = OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				await (s.CreateQuery(queryString).SetCacheable(true).ListAsync());
				await (tx.CommitAsync());
			}

			Assert.That(qs.CacheHitCount, Is.EqualTo(1));

			using (ISession s = OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				await (s.CreateQuery(queryString).SetCacheable(true).SetResultTransformer(transformer).ListAsync());
				await (tx.CommitAsync());
			}

			Assert.That(qs.CacheHitCount, Is.EqualTo(2), "hit count should go up since the cache contains the result before the possible application of a resulttransformer");

			using (ISession s = OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				await (s.CreateQuery(queryString).SetCacheable(true).SetResultTransformer(transformer).ListAsync());
				await (tx.CommitAsync());
			}

			Assert.That(qs.CacheHitCount, Is.EqualTo(3), "hit count should go up since we are using the same resulttransformer");
			using (ISession s = OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				result = await (s.CreateQuery(queryString).SetCacheable(true).ListAsync());
				Assert.That(result.Count, Is.EqualTo(1));
				var i = await (s.GetAsync<AnotherItem>(savedId));
				i.Name = "Widget";
				await (tx.CommitAsync());
			}

			Assert.That(qs.CacheHitCount, Is.EqualTo(4));
			Assert.That(qs.CacheMissCount, Is.EqualTo(2));

			await (Task.Delay(200));

			using (ISession s = OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				await (s.CreateQuery(queryString).SetCacheable(true).ListAsync());

				var i = await (s.GetAsync<AnotherItem>(savedId));
				Assert.That(i.Name, Is.EqualTo("Widget"));

				await (s.DeleteAsync(i));
				await (tx.CommitAsync());
			}

			Assert.That(qs.CacheHitCount, Is.EqualTo(4));
			Assert.That(qs.CacheMissCount, Is.EqualTo(3));
			Assert.That(qs.CachePutCount, Is.EqualTo(3));
			Assert.That(qs.ExecutionCount, Is.EqualTo(3));
			Assert.That(es.FetchCount, Is.EqualTo(0)); //check that it was being cached
		}

		public class CustomTransformer : IResultTransformer
		{
			public object TransformTuple(object[] tuple, string[] aliases)
			{
				// Some db change the empty string to null, causing .ToString() to blow.
				// https://stackoverflow.com/a/203536/1178314
				return new AnotherItem { Name = tuple[0]?.ToString(), Description = tuple[1]?.ToString() };
			}

			public IList TransformList(IList collection)
			{
				return collection;
			}
		}
	}
}