//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System.Linq;
using NHibernate.Cfg;
using NHibernate.DomainModel.Northwind.Entities;
using NUnit.Framework;
using NHibernate.Linq;

namespace NHibernate.Test.QueryTranslator
{
	using System.Threading.Tasks;
	[TestFixture(Description = "Tests a custom query translator factory for all query interfaces.")]
	internal sealed class CustomQueryLoaderFixtureAsync : TestCase
	{
		private ISession _session;
		private ITransaction _transaction;

		protected override string[] Mappings =>
			new[]
			{
				"Northwind.Mappings.Customer.hbm.xml",
				"Northwind.Mappings.Employee.hbm.xml",
				"Northwind.Mappings.Order.hbm.xml",
				"Northwind.Mappings.OrderLine.hbm.xml",
				"Northwind.Mappings.Product.hbm.xml",
				"Northwind.Mappings.ProductCategory.hbm.xml",
				"Northwind.Mappings.Region.hbm.xml",
				"Northwind.Mappings.Shipper.hbm.xml",
				"Northwind.Mappings.Supplier.hbm.xml",
				"Northwind.Mappings.Territory.hbm.xml",
				"Northwind.Mappings.AnotherEntity.hbm.xml",
				"Northwind.Mappings.Role.hbm.xml",
				"Northwind.Mappings.User.hbm.xml",
				"Northwind.Mappings.TimeSheet.hbm.xml",
				"Northwind.Mappings.Animal.hbm.xml",
				"Northwind.Mappings.Patient.hbm.xml",
				"Northwind.Mappings.NumericEntity.hbm.xml"
			};

		protected override string MappingsAssembly => "NHibernate.DomainModel";

		protected override void Configure(Configuration configuration)
		{
			configuration.SetProperty(Environment.QueryTranslator, typeof(CustomQueryTranslatorFactory).AssemblyQualifiedName);
		}

		protected override void OnSetUp()
		{
			base.OnSetUp();

			_session = OpenSession();
			_transaction = _session.BeginTransaction();

			var customer = new Customer
			{
				CustomerId = "C1",
				CompanyName = "Company"
			};
			_session.Save(customer);
			_session.Flush();
			_session.Clear();
		}

		protected override void OnTearDown()
		{
			base.OnTearDown();

			_transaction.Rollback();
			_transaction.Dispose();
			_session.Close();
			_session.Dispose();
		}

		[Test(Description = "Tests criteria queries.")]
		public async Task CriteriaQueryTestAsync()
		{
			var customers = await (_session.CreateCriteria(typeof(Customer))
									.ListAsync<Customer>());

			Assert.That(customers.Count, Is.EqualTo(1));
		}

		[Test(Description = "Tests future queries.")]
		public async Task FutureQueryTestAsync()
		{
			var futureCustomers = _session
				.CreateQuery("select c from Customer c")
				.Future<Customer>();
			var futureCustomersCount = _session
				.CreateQuery("select count(*) from Customer c")
				.FutureValue<long>();

			Assert.That(await (futureCustomersCount.GetValueAsync()), Is.EqualTo(1));
			Assert.That(futureCustomers.ToList().Count, Is.EqualTo(await (futureCustomersCount.GetValueAsync())));
		}

		[Test(Description = "Tests HQL queries.")]
		public async Task HqlQueryTestAsync()
		{
			var customers = await (_session.CreateQuery("select c from Customer c")
									.ListAsync<Customer>());

			Assert.That(customers.Count, Is.EqualTo(1));
		}

		[Test(Description = "Tests LINQ queries.")]
		public async Task LinqQueryTestAsync()
		{
			var customers = await (_session.Query<Customer>()
									.ToListAsync());

			Assert.That(customers.Count, Is.EqualTo(1));
		}

		[Test(Description = "Tests query over queries.")]
		public async Task QueryOverQueryTestAsync()
		{
			var customers = await (_session.QueryOver<Customer>()
									.ListAsync<Customer>());

			Assert.That(customers.Count, Is.EqualTo(1));
		}
	}
}
