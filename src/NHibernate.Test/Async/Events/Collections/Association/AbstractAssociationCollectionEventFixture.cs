//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using NHibernate.Test.Events.Collections.Association.Bidirectional.ManyToMany;
using NUnit.Framework;

namespace NHibernate.Test.Events.Collections.Association
{
	using System.Threading.Tasks;
	[TestFixture]
	public abstract class AbstractAssociationCollectionEventFixtureAsync : AbstractCollectionEventFixtureAsync
	{
		[Test]
		public async Task DeleteParentButNotChildAsync()
		{
			CollectionListeners listeners = new CollectionListeners(Sfi);
			IParentWithCollection parent = await (CreateParentWithOneChildAsync("parent", "child"));
			ChildEntity child = (ChildEntity) GetFirstChild(parent.Children);
			listeners.Clear();
			ISession s = OpenSession();
			ITransaction tx = s.BeginTransaction();
			parent = (IParentWithCollection) await (s.GetAsync(parent.GetType(), parent.Id));
			child = (ChildEntity) await (s.GetAsync(child.GetType(), child.Id));
			parent.RemoveChild(child);
			await (s.DeleteAsync(parent));
			await (tx.CommitAsync());
			s.Close();
			int index = 0;
			CheckResult(listeners, listeners.InitializeCollection, parent, index++);
			if (child is ChildWithBidirectionalManyToMany)
			{
				CheckResult(listeners, listeners.InitializeCollection, (ChildWithBidirectionalManyToMany) child, index++);
			}
			CheckResult(listeners, listeners.PreCollectionRemove, parent, index++);
			CheckResult(listeners, listeners.PostCollectionRemove, parent, index++);
			if (child is ChildWithBidirectionalManyToMany)
			{
				CheckResult(listeners, listeners.PreCollectionUpdate, (ChildWithBidirectionalManyToMany) child, index++);
				CheckResult(listeners, listeners.PostCollectionUpdate, (ChildWithBidirectionalManyToMany) child, index++);
			}
			CheckNumberOfResults(listeners, index);
		}
	}
}
