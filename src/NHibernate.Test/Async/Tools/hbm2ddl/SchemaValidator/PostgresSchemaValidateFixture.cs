//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System;
using NHibernate.Cfg;
using NHibernate.Dialect;
using NHibernate.Mapping.ByCode;
using NHibernate.Tool.hbm2ddl;
using NUnit.Framework;

namespace NHibernate.Test.Tools.hbm2ddl.SchemaValidator
{
	using System.Threading.Tasks;
	[TestFixture]
	public class PostgresSchemaValidateFixtureAsync
	{
		[Test]
		public async Task ShouldBeInvalidIfTimestampTzIsExpectedAndGotTimestampAsync()
		{
			var actual = BuildConfiguration("timestamp");
			Assume.That(Dialect.Dialect.GetDialect(actual.Properties) is PostgreSQLDialect);

			var expected = BuildConfiguration("timestamptz");

			var export = new SchemaExport(actual);
			await (export.CreateAsync(true, true));

			try
			{
				var validator = new Tool.hbm2ddl.SchemaValidator(expected);

				var error = Assert.ThrowsAsync<SchemaValidationException>(() => validator.ValidateAsync());
				Assert.That(error, Has.Message.StartsWith("Schema validation failed: see list of validation errors"));
				Assert.That(
					error,
					Has.Property("ValidationErrors").Some.Contains("Wrong column type").IgnoreCase
					   .And.Contains("for column CreatedAt. Found: timestamp, Expected timestamptz").IgnoreCase);
			}
			finally
			{
				await (export.DropAsync(true, true));
			}
		}

		[Test]
		public async Task ShouldBeInvalidIfTimestampIsExpectedAndGotTimestampTzAsync()
		{
			var actual = BuildConfiguration("timestamptz");
			Assume.That(Dialect.Dialect.GetDialect(actual.Properties) is PostgreSQLDialect);
				
			var expected = BuildConfiguration("timestamp");

			var export = new SchemaExport(actual);
			await (export.CreateAsync(true, true));

			try
			{
				var validator = new Tool.hbm2ddl.SchemaValidator(expected);

				var error = Assert.ThrowsAsync<SchemaValidationException>(() => validator.ValidateAsync());
				Assert.That(error, Has.Message.StartsWith("Schema validation failed: see list of validation errors"));
				Assert.That(
					error,
					Has.Property("ValidationErrors").Some.Contains("Wrong column type").IgnoreCase
					   .And.Contains("for column CreatedAt. Found: timestamptz, Expected timestamp").IgnoreCase);
			}
			finally
			{
				await (export.DropAsync(true, true));
			}
		}

		private static Configuration BuildConfiguration(string type)
		{
			var mapper = new ModelMapper();
			mapper.Class<Entity>(c =>
			{
				c.Table("Entity");
				c.Id(x => x.Id);
				c.Property(x => x.CreatedAt, p => p.Column(cm => cm.SqlType(type)));
			});

			var cfg = TestConfigurationHelper.GetDefaultConfiguration();
			cfg.AddDeserializedMapping(mapper.CompileMappingForAllExplicitlyAddedEntities(), "Entity");
			return cfg;
		}

		public class Entity
		{
			public virtual int Id { get; set; }
			public virtual DateTime CreatedAt { get; set; }
		}
	}
}
