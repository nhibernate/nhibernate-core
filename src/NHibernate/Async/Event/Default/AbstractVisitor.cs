//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using NHibernate.Persister.Entity;
using NHibernate.Type;

namespace NHibernate.Event.Default
{
	using System.Threading.Tasks;
	using System.Threading;
	public abstract partial class AbstractVisitor
	{

		/// <summary> Dispatch each property value to ProcessValue(). </summary>
		/// <param name="values"> </param>
		/// <param name="types"> </param>
		/// <param name="cancellationToken">A cancellation token that can be used to cancel the work</param>
		internal async Task ProcessValuesAsync(object[] values, IType[] types, CancellationToken cancellationToken)
		{
			cancellationToken.ThrowIfCancellationRequested();
			for (int i = 0; i < types.Length; i++)
			{
				if (IncludeProperty(values, i))
					await (ProcessValueAsync(i, values, types, cancellationToken)).ConfigureAwait(false);
			}
		}

		internal virtual Task ProcessValueAsync(int i, object[] values, IType[] types, CancellationToken cancellationToken)
		{
			if (cancellationToken.IsCancellationRequested)
			{
				return Task.FromCanceled<object>(cancellationToken);
			}
			try
			{
				return ProcessValueAsync(values[i], types[i], cancellationToken);
			}
			catch (System.Exception ex)
			{
				return Task.FromException<object>(ex);
			}
		}

		/// <summary> 
		/// Visit a property value. Dispatch to the correct handler for the property type.
		/// </summary>
		/// <param name="value"> </param>
		/// <param name="type"> </param>
		/// <param name="cancellationToken">A cancellation token that can be used to cancel the work</param>
		internal Task<object> ProcessValueAsync(object value, IType type, CancellationToken cancellationToken)
		{
			if (cancellationToken.IsCancellationRequested)
			{
				return Task.FromCanceled<object>(cancellationToken);
			}
			try
			{
				if (type.IsCollectionType)
				{
					//even process null collections
					return ProcessCollectionAsync(value, (CollectionType)type, cancellationToken);
				}
				else if (type.IsEntityType)
				{
					return Task.FromResult<object>(ProcessEntity(value, (EntityType)type));
				}
				else if (type.IsComponentType)
				{
					return ProcessComponentAsync(value, (IAbstractComponentType)type, cancellationToken);
				}
				else
				{
					return Task.FromResult<object>(null);
				} 
			}
			catch (System.Exception ex)
			{
				return Task.FromException<object>(ex);
			}
		}

		/// <summary>
		/// Visit a component. Dispatch each property to <see cref="ProcessValuesAsync(object[],IType[],CancellationToken)"/>
		/// </summary>
		/// <param name="component"></param>
		/// <param name="componentType"></param>
		/// <param name="cancellationToken">A cancellation token that can be used to cancel the work</param>
		/// <returns></returns>
		internal virtual async Task<object> ProcessComponentAsync(object component, IAbstractComponentType componentType, CancellationToken cancellationToken)
		{
			cancellationToken.ThrowIfCancellationRequested();
			if (component != null)
			{
				await (ProcessValuesAsync(await (componentType.GetPropertyValuesAsync(component, session, cancellationToken)).ConfigureAwait(false), componentType.Subtypes, cancellationToken)).ConfigureAwait(false);
			}
			return null;
		}

		/// <summary>
		/// Visit a collection. Default superclass implementation is a no-op.
		/// </summary>
		/// <param name="value"></param>
		/// <param name="collectionType"></param>
		/// <param name="cancellationToken">A cancellation token that can be used to cancel the work</param>
		/// <returns></returns>
		internal virtual Task<object> ProcessCollectionAsync(object value, CollectionType collectionType, CancellationToken cancellationToken)
		{
			if (cancellationToken.IsCancellationRequested)
			{
				return Task.FromCanceled<object>(cancellationToken);
			}
			try
			{
				return Task.FromResult<object>(ProcessCollection(value, collectionType));
			}
			catch (System.Exception ex)
			{
				return Task.FromException<object>(ex);
			}
		}

		/// <summary>
		/// Walk the tree starting from the given entity.
		/// </summary>
		/// <param name="obj"></param>
		/// <param name="persister"></param>
		/// <param name="cancellationToken">A cancellation token that can be used to cancel the work</param>
		internal virtual Task ProcessAsync(object obj, IEntityPersister persister, CancellationToken cancellationToken)
		{
			if (cancellationToken.IsCancellationRequested)
			{
				return Task.FromCanceled<object>(cancellationToken);
			}
			try
			{
				return ProcessEntityPropertyValuesAsync(persister.GetPropertyValues(obj), persister.PropertyTypes, cancellationToken);
			}
			catch (System.Exception ex)
			{
				return Task.FromException<object>(ex);
			}
		}

		public async Task ProcessEntityPropertyValuesAsync(object[] values, IType[] types, CancellationToken cancellationToken)
		{
			cancellationToken.ThrowIfCancellationRequested();
			for (int i = 0; i < types.Length; i++)
			{
				if (IncludeEntityProperty(values, i))
				{
					await (ProcessValueAsync(i, values, types, cancellationToken)).ConfigureAwait(false);
				}
			}
		}
	}
}
